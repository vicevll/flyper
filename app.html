<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="src/favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flyper - Vuelo en Curso</title>
    
    <!-- Tailwind CSS with Dark Mode Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            text: '#f8fafc'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <!-- Confetti.js -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* FIX: Asegurar altura completa para que el mapa se renderice */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* Original Styles */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        /* Mapa a pantalla completa */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: #f3f4f6;
            transition: filter 0.5s ease;
        }
        
        html.dark #map {
            background: #030712;
        }

        /* Estilo del Avión */
        .plane-icon {
            color: #0077b6;
            filter: drop-shadow(0px 4px 4px rgba(0,0,0,0.4));
            transition: transform 0.2s linear;
            transform-origin: center center;
            display: block;
        }
        
        html.dark .plane-icon {
            color: #38bdf8;
            filter: drop-shadow(0px 4px 4px rgba(0,0,0,0.8));
        }

        /* Glass HUD & Buttons */
        .glass-panel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.4));
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.5);
            transition: all 0.3s ease;
        }
        html.dark .glass-panel {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(30, 41, 59, 0.6));
            border: 1px solid rgba(255,255,255,0.1);
            color: #f8fafc;
        }

        .hud-panel {
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            @apply glass-panel;
        }
        
        .hud-panel, .music-btn, .music-menu, .theme-toggle, .task-panel, .cancel-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.5)) !important;
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            border: 1px solid rgba(255,255,255,0.6) !important;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.2), 0 4px 10px -5px rgba(0, 0, 0, 0.1) !important;
        }
        html.dark .hud-panel, html.dark .music-btn, html.dark .music-menu, html.dark .theme-toggle, html.dark .task-panel, html.dark .cancel-btn {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.7)) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.5), 0 5px 15px -5px rgba(0, 0, 0, 0.3) !important;
            color: #e2e8f0;
        }

        /* Music Player Styles */
        .music-btn, .theme-toggle, .cancel-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s, color 0.2s;
            color: #334155;
            z-index: 101;
        }
        .music-btn:hover, .theme-toggle:hover {
            transform: scale(1.1);
            background: white;
            color: #0077b6;
        }
        html.dark .music-btn:hover, html.dark .theme-toggle:hover {
            background: #1e293b;
            color: #38bdf8;
        }
        
        .cancel-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #ef4444;
        }
        html.dark .cancel-btn {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }
        .cancel-btn:hover {
            background: #ef4444 !important;
            color: white !important;
            border-color: #ef4444 !important;
        }
        
        .music-btn.active {
            color: #0077b6;
            border: 2px solid #0077b6;
        }
        html.dark .music-btn.active {
            color: #38bdf8;
            border: 2px solid #38bdf8;
        }
        
        @keyframes sound-wave {
            0% { transform: scaleY(1); }
            50% { transform: scaleY(0.5); }
            100% { transform: scaleY(1); }
        }
        .wave-bar {
            width: 3px;
            background-color: #0077b6;
            margin: 0 1px;
            border-radius: 2px;
            animation: sound-wave 1s infinite ease-in-out;
            display: none;
        }
        html.dark .wave-bar { background-color: #38bdf8; }
        .playing .wave-bar { display: block; }
        .playing .wave-bar:nth-child(2) { animation-delay: 0.2s; }
        .playing .wave-bar:nth-child(3) { animation-delay: 0.4s; }

        .music-menu, .task-overlay-list {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            width: 320px;
            max-height: 60vh;
            overflow-y: auto !important;
            border-radius: 20px;
            padding: 16px;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            margin-bottom: 0;
        }

        .music-menu.open, .task-overlay-list.open {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .active-task-menu {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            width: 320px;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            margin-bottom: 0;
            border-radius: 20px;
            padding: 16px;
        }

        .active-task-menu.open {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        @media (min-width: 1024px) {
            .active-task-menu {
                left: 24px !important;
                top: 100px !important;
                transform: translateY(-20px) !important;
                width: 380px !important;
                max-height: 35vh;
            }
            .task-overlay-list {
                left: 24px !important;
                top: 310px !important;
                transform: translateY(-20px) !important;
                width: 380px !important;
                max-height: 55vh;
            }
            .active-task-menu.open, .task-overlay-list.open, .music-menu.open {
                transform: translateY(0) !important;
                opacity: 1 !important;
                pointer-events: auto !important;
            }
            .music-menu {
                top: 100px !important;
                right: 80px !important;
                left: auto !important;
                transform: translateY(-20px) !important;
            }
        }

        .track-item {
            display: flex;
            align-items: center;
            padding: 12px 12px; 
            gap: 12px; 
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            color: #475569;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 4px;
        }
        html.dark .track-item { color: #cbd5e1; }
        .track-item:hover {
            background: #f1f5f9;
        }
        html.dark .track-item:hover {
            background: #334155;
        }
        .track-item.selected {
            background: #e0f2fe;
            color: #0077b6;
            font-weight: 600;
        }
        html.dark .track-item.selected {
            background: #0c4a6e;
            color: #7dd3fc;
        }
        
        input[type=range] {
            width: 100%; 
            height: 6px;
            border-radius: 4px;
            appearance: none;
            margin-top: 8px;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #0077b6;
            margin-top: -5px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        html.dark input[type=range]::-webkit-slider-thumb {
            background: #38bdf8;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            background: #cbd5e1;
            border-radius: 4px;
        }
        html.dark input[type=range]::-webkit-slider-runnable-track {
            background: #475569;
        }

        .active-task-pulse {
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0% { border-color: rgba(14, 165, 233, 0.5); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.4); }
            70% { border-color: rgba(14, 165, 233, 1); box-shadow: 0 0 0 10px rgba(14, 165, 233, 0); }
            100% { border-color: rgba(14, 165, 233, 0.5); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }
        }

        .flight-task-item {
            transition: all 0.2s ease;
        }
        .flight-task-edit-menu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, margin-top 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }
        .flight-task-edit-menu.open {
            max-height: 100px;
            margin-top: 8px;
            opacity: 1;
        }
        .flight-task-item.sortable-ghost {
            background: #334155;
        }

        .button-glow {
            background: #5e60ce !important;
            background-color: #5e60ce !important;
            color: white !important;
            border: none !important;
            box-shadow: 0 4px 15px rgba(94, 96, 206, 0.4) !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            opacity: 1 !important;
        }
        html.dark .button-glow {
            background-color: #5e60ce !important;
            color: white !important;
            border: none !important;
            box-shadow: 0 4px 20px rgba(94, 96, 206, 0.6) !important;
        }

        .right-button-stack {
            position: absolute;
            top: 55%;
            right: 16px;
            transform: translateY(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
            pointer-events: none;
        }
        .right-button-stack > * {
            pointer-events: auto;
        }

        /* FLYPER Logo Styles */
        .flyper-logo-map {
            width: 45px;
            height: auto;
            margin-bottom: 2rem;
            transition: transform 0.3s ease, filter 0.3s ease;
        }

        .flyper-logo-map img {
            width: 100%;
            height: auto;
            filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.1));
            transition: filter 0.3s ease;
        }

        html.dark .flyper-logo-map img {
            filter: drop-shadow(0px 0px 12px rgba(56,189,248,0.25));
        }

        /* Responsive sizing */
        @media (max-width: 768px) {
            .flyper-logo-map {
                width: 45px;
            }
            .task-overlay-list, .active-task-menu {
                width: calc(100vw - 32px) !important;
                max-width: 320px;
            }
            .hud-panel {
                padding: 12px !important;
            }
            #hud-timer {
                font-size: 1.25rem !important;
            }
            .max-w-3xl.mx-auto.flex.flex-wrap {
                flex-wrap: nowrap !important;
                gap: 4px !important;
                justify-content: space-between !important;
                width: 95% !important;
            }
            .max-w-3xl.mx-auto.flex.flex-wrap .hud-panel {
                min-width: 0 !important;
                padding: 6px 8px !important;
                flex: 1 !important;
            }
            .max-w-3xl.mx-auto.flex.flex-wrap .hud-panel .text-\[10px\] {
                font-size: 8px !important;
            }
            .max-w-3xl.mx-auto.flex.flex-wrap .hud-panel .text-xl,
            .max-w-3xl.mx-auto.flex.flex-wrap .hud-panel .text-2xl {
                font-size: 14px !important;
            }
            #hud-timer {
                font-size: 14px !important;
            }
        }

        @media (max-width: 576px) {
            .flyper-logo-map {
                width: 40px;
            }
            .boucher-peek {
                width: 90%;
                bottom: -170px;
            }
            .boucher-peek:hover {
                bottom: -5px;
            }
            .music-menu {
                width: calc(100vw - 32px);
                right: 0;
            }
            .glass-panel {
                padding: 1.5rem !important;
            }
        }

        @media (max-width: 400px) {
            .max-w-2xl.mx-auto.grid.grid-cols-3 {
                grid-template-cols: 1fr 40px 1fr !important;
                gap: 2px !important;
            }
            .hud-panel {
                padding: 8px !important;
            }
            .hud-panel div.text-lg {
                font-size: 1rem !important;
            }
            .boucher-peek {
                width: 95%;
            }
        }

        /* Custom Scrollbar for Dropdown */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }
        html.dark .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        html.dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Prevent text selection */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        input, select, textarea {
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }

        /* Boucher Peek Effect Styles */
        .boucher-peek {
            position: absolute;
            bottom: -160px;
            left: 50%;
            transform: translateX(-50%);
            width: 320px;
            height: 210px;
            z-index: 150;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: auto;
        }
        .boucher-peek:hover {
            bottom: -5px;
        }
        .boucher-content {
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(224, 242, 254, 0.9));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.15);
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        html.dark .boucher-content {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.4);
        }
        .boucher-handle-line {
            width: 40px;
            height: 4px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
            margin: 0 auto 10px;
        }
        html.dark .boucher-handle-line {
            background: rgba(255, 255, 255, 0.2);
        }

        #btn-active-task-toggle {
            pointer-events: auto !important;
            z-index: 1000 !important;
        }

        /* Estado de Tiempo Agotado */
        .task-overtime {
            background: #c1121f !important;
            border-color: #780001 !important;
            color: white !important;
        }
        .task-overtime div, .task-overtime span {
            color: white !important;
        }
        .task-overtime .bg-gray-200 {
            background: rgba(255,255,255,0.2) !important;
        }
        .task-overtime #active-task-bar {
            background: white !important;
        }

        /* Animación para el botón siguiente */
        .btn-next-task {
            background: white;
            color: #c1121f;
            font-weight: 800;
            padding: 8px 16px;
            border-radius: 12px;
            margin-top: 12px;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 12px;
            transition: all 0.3s ease;
            display: none;
        }
        .task-overtime .btn-next-task {
            display: block;
            animation: pulse-white 2s infinite;
        }
        @keyframes pulse-white {
            0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255,255,255,0); }
            100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
        }

        /* OCULTAR UI PARA MODALES */
        .hide-ui .right-button-stack,
        .hide-ui .active-task-menu,
        .hide-ui .task-panel,
        .hide-ui .boucher-peek,
        .hide-ui .flyper-logo-map,
        .hide-ui div.absolute.top-0,
        .hide-ui div.absolute.bottom-8 {
            display: none !important;
        }

    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-950 text-gray-800 dark:text-gray-100">

    <!-- AUDIO ELEMENTS -->
    <audio id="audio-player" loop crossorigin="anonymous"></audio>
    <audio id="sfx-success" src="src/sounds/copano.mp3" preload="auto"></audio>
    <audio id="sfx-overtime" src="src/sounds/ringring.mp3" preload="auto"></audio>
    <audio id="sfx-achievement" src="src/sounds/Sonido%20de%20moneda%20Mario.mp3" preload="auto"></audio>

    <!-- APP CONTAINER -->
    <div id="app" class="relative w-full h-full">

        <!-- PANTALLA 3: MAPA Y VUELO -->
        <div id="screen-flight" class="h-full w-full relative overflow-hidden">
            <div id="map"></div>

            <!-- STACK DE BOTONES (DERECHA) -->
            <div class="right-button-stack">
                
                <!-- BOTÓN MÚSICA -->
                <div class="relative">
                    <button id="btn-music-toggle" onclick="toggleMusicMenu()" class="music-btn" title="Música de Fondo">
                        <i class="fa-solid fa-music text-lg" id="music-icon"></i>
                        <div class="h-4 flex items-end ml-1 gap-[2px]" id="music-waves" style="display:none;">
                            <div class="wave-bar h-3"></div>
                            <div class="wave-bar h-4"></div>
                            <div class="wave-bar h-2"></div>
                        </div>
                    </button>
                </div>

                <!-- BOTÓN PAUSA -->
                <div class="relative">
                    <button onclick="togglePauseMenu()" class="music-btn shadow-lg" title="Descansar">
                        <i class="fa-solid fa-mug-hot"></i>
                    </button>
                </div>

                <!-- BOTÓN ABORTAR VUELO -->
                <button onclick="cancelFlight()" class="cancel-btn shadow-lg" title="Abortar Vuelo">
                    <i class="fa-solid fa-plane-slash"></i>
                </button>

                <!-- BOTÓN CAMBIAR TEMA -->
                <button onclick="toggleTheme()" class="theme-toggle shadow-lg" title="Cambiar Tema">
                    <i class="fa-solid fa-moon dark:hidden"></i>
                    <i class="fa-solid fa-sun hidden dark:inline text-yellow-400"></i>
                </button>
            </div>

            <!-- PAUSE OVERLAY -->
            <div id="music-menu" class="music-menu task-panel glass-panel">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800 dark:text-white text-base">Atmósfera de Estudio (Radio)</h3>
                    <button onclick="toggleMusicMenu()" class="text-gray-400 hover:text-red-500" style="pointer-events: auto;"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div class="space-y-1">
                    <div class="track-item" onclick="playTrack('https://stream.zeno.fm/0r0xa792kwzuv', this)">
                        <i class="fa-solid fa-radio text-indigo-500"></i> 
                        <div class="flex flex-col leading-tight">
                            <span>Lofi Hip Hop Radio</span>
                            <span class="text-[9px] text-gray-400 font-normal">Beats para estudiar/relajarse</span>
                        </div>
                    </div>
                    <div class="track-item" onclick="playTrack('https://pianosolo.streamguys1.com/live', this)">
                        <i class="fa-solid fa-wind text-sky-500"></i> 
                        <div class="flex flex-col leading-tight">
                            <span>Piano & Ambient</span>
                            <span class="text-[9px] text-gray-400 font-normal">Melodías suaves en vivo</span>
                        </div>
                    </div>
                    <div class="track-item" onclick="playTrack('src/sounds/Musica_lluvia.mp3', this)">
                        <i class="fa-solid fa-cloud-rain text-teal-500"></i> 
                        <div class="flex flex-col leading-tight">
                            <span>Lluvia Suave</span>
                            <span class="text-[9px] text-gray-400 font-normal">Ambiente tranquilo</span>
                        </div>
                    </div>
                </div>

                <div class="mt-4 mb-2 px-2">
                    <div class="flex justify-between text-[10px] text-gray-400 uppercase font-bold mb-1">
                        <span>Volumen</span>
                        <span id="vol-label">50%</span>
                    </div>
                    <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="0.5" oninput="changeVolume(this.value)">
                </div>
                
                <div class="border-t border-gray-200 dark:border-gray-700 mt-2 pt-2">
                    <div class="track-item text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20" onclick="stopMusic()">
                        <i class="fa-solid fa-stop"></i> Detener Radio
                    </div>
                </div>
            </div>



            <!-- PAUSE MENU -->
            <div id="pause-menu" class="music-menu task-panel glass-panel" style="z-index: 1100;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800 dark:text-white text-base">Tomar un Descanso</h3>
                    <button onclick="togglePauseMenu()" class="text-gray-400 hover:text-red-500" style="pointer-events: auto;"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">El tiempo de vuelo y la tarea actual se detendrán.</p>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="startPause(5)" class="bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:hover:bg-blue-900/40 text-blue-600 dark:text-blue-400 font-bold py-2 rounded-lg text-sm transition">5m</button>
                    <button onclick="startPause(10)" class="bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:hover:bg-blue-900/40 text-blue-600 dark:text-blue-400 font-bold py-2 rounded-lg text-sm transition">10m</button>
                    <button onclick="startPause(15)" class="bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:hover:bg-blue-900/40 text-blue-600 dark:text-blue-400 font-bold py-2 rounded-lg text-sm transition">15m</button>
                    <button onclick="startPause(20)" class="bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:hover:bg-blue-900/40 text-blue-600 dark:text-blue-400 font-bold py-2 rounded-lg text-sm transition">20m</button>
                    <button onclick="startPause(25)" class="bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:hover:bg-blue-900/40 text-blue-600 dark:text-blue-400 font-bold py-2 rounded-lg text-sm transition">25m</button>
                    <button onclick="startPause(30)" class="bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:hover:bg-blue-900/40 text-blue-600 dark:text-blue-400 font-bold py-2 rounded-lg text-sm transition">30m</button>
                </div>
            </div>

            <!-- PAUSE OVERLAY (Remaining html...) -->
            <!-- ... -->
            
            <!-- SCRIPTS -->
            <!-- ... -->
            <!-- Need to inject JS updates inside existing script block logic, but 'replace' tool works on text blocks. -->
            <!-- I will replace the JS functions inside the script tag by targeting them via context -->


            <!-- PAUSE OVERLAY -->
            <div id="pause-overlay" class="hidden absolute inset-0 z-[2000] bg-black/60 backdrop-blur-md flex flex-col items-center justify-center text-white">
                <div class="w-24 h-24 bg-white/10 rounded-full flex items-center justify-center mb-6 animate-pulse">
                    <i class="fa-solid fa-mug-hot text-4xl"></i>
                </div>
                <h2 class="text-3xl font-black mb-2">En Pausa</h2>
                <div class="text-6xl font-mono font-bold mb-8" id="pause-countdown">00:00</div>
                <button onclick="resumeFlight()" class="bg-white text-blue-900 font-bold py-3 px-8 rounded-full hover:scale-105 transition transform shadow-xl">
                    <i class="fa-solid fa-play mr-2"></i> Reanudar Vuelo
                </button>
            </div>

            <!-- HUD SUPERIOR (TIEMPO, FINALIZACIÓN, PROGRESO, TAREA ACTUAL) -->
            <div class="absolute top-0 left-0 right-0 p-4 z-[90] pointer-events-none">
                <div class="max-w-3xl mx-auto flex flex-col gap-3 pointer-events-auto">
                    
                    <!-- Top Stats Row -->
                    <div class="flex flex-wrap justify-center gap-3">
                        <!-- Caja 1: Tiempo Restante -->
                        <div class="hud-panel p-3 px-5 text-center min-w-[140px] flex-1">
                            <div class="text-[10px] text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider mb-1">Tiempo Restante</div>
                            <div class="text-2xl font-mono font-bold text-gray-800 dark:text-white" id="hud-timer">00:00:00</div>
                        </div>
                        
                        <!-- Caja 2: Finalización -->
                        <div class="hud-panel p-3 px-5 text-center min-w-[140px] flex-1">
                            <div class="text-[10px] text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider mb-1">Finalización</div>
                            <div class="text-xl font-mono font-bold text-gray-800 dark:text-white leading-none" id="hud-arrival">--:--</div>
                            <div class="text-[10px] text-gray-400 font-mono mt-1" id="hud-arrival-date">--/--/--</div>
                        </div>
                        
                        <!-- Caja 3: Progreso -->
                        <div class="hud-panel p-3 px-5 text-center min-w-[120px] flex-1 flex flex-col justify-center">
                            <div class="text-[10px] text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider mb-1">Progreso</div>
                            <div class="text-2xl font-bold text-[#0077b6] dark:text-[#38bdf8]" id="hud-pct">0%</div>
                        </div>
                    </div>

                    <!-- ACTIVE TASK BAR (FIXED) -->
                    <div id="top-active-task-bar" class="hud-panel p-3 flex flex-wrap items-center justify-between gap-2 sm:gap-4 transition-all duration-300 relative overflow-visible shadow-xl">
                        
                        <!-- Task Info & Dropdown Trigger -->
                        <div class="flex-1 flex items-center gap-3 cursor-pointer group min-w-[150px]" onclick="toggleTaskDropdown()">
                            <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 group-hover:scale-110 transition-transform flex-shrink-0">
                                <i class="fa-solid fa-layer-group" id="task-icon-status"></i>
                            </div>
                            <div class="flex flex-col overflow-hidden min-w-0">
                                <div class="text-[10px] text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider flex items-center gap-1">
                                    <span id="top-bar-status">Tarea Actual</span>
                                    <i class="fa-solid fa-chevron-down text-[10px] opacity-50 transition-transform duration-300" id="task-dropdown-chevron"></i>
                                </div>
                                <div class="text-base font-bold text-gray-800 dark:text-white truncate max-w-[150px] sm:max-w-none" id="top-bar-title">Preparando Vuelo...</div>
                            </div>
                        </div>

                        <!-- Timer & Progress -->
                        <div class="flex items-center gap-3 sm:gap-4 flex-shrink-0 ml-auto">
                            <div class="text-right block">
                                <div class="text-lg font-mono font-bold text-gray-800 dark:text-white leading-none" id="top-bar-timer">--m</div>
                            </div>
                            
                            <!-- Complete Checkbox -->
                            <button onclick="completeCurrentTask()" class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gray-100 dark:bg-gray-700/50 hover:bg-green-500 hover:text-white dark:hover:bg-green-500 text-gray-400 transition-all duration-200 flex items-center justify-center shadow-inner group" title="Completar Tarea">
                                <i class="fa-solid fa-check text-lg sm:text-xl transform group-hover:scale-125 transition-transform"></i>
                            </button>
                        </div>
                        
                        <!-- Progress Bar Background -->
                        <div class="absolute bottom-0 left-0 h-1 bg-gray-200 dark:bg-gray-700 w-full rounded-b-xl overflow-hidden">
                            <div id="top-bar-progress" class="h-full bg-blue-500 transition-all duration-1000" style="width: 0%"></div>
                        </div>

                    </div>

                    <!-- TASK DROPDOWN (REST OF TASKS) -->
                    <div id="top-task-dropdown" class="max-h-0 overflow-hidden transition-all duration-500 ease-in-out opacity-0 translate-y-[-10px]">
                        <div class="hud-panel p-4 mt-1 max-h-[50vh] overflow-y-auto custom-scrollbar">
                            <div class="flex justify-between items-center mb-3 sticky top-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md pb-2 border-b border-gray-100 dark:border-gray-700 z-10">
                                <h3 class="font-bold text-sm text-gray-600 dark:text-gray-300">Próximas Tareas</h3>
                                <button onclick="addTaskInFlight()" class="text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-2 py-1 rounded hover:bg-blue-200 transition">
                                    <i class="fa-solid fa-plus"></i> Añadir
                                </button>
                            </div>
                            
                             <div class="flex gap-2 mb-3">
                                <input type="text" id="flight-task-input" placeholder="Nueva tarea..." 
                                    class="flex-1 bg-white/50 dark:bg-black/30 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-1.5 text-xs focus:outline-none focus:border-blue-500 dark:text-white">
                             </div>

                            <div id="flight-tasks-container" class="space-y-2">
                                <!-- Tasks injected here -->
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- HUD INFERIOR (TELEMTRÍA) -->
            <div class="absolute bottom-8 left-0 right-0 px-4 z-[100] pointer-events-none">
                <div class="max-w-2xl mx-auto grid grid-cols-3 gap-4 pointer-events-auto">
                    <div class="hud-panel p-3 text-center">
                        <i class="fa-solid fa-gauge text-gray-400 mb-1"></i>
                        <div class="text-lg font-bold text-gray-800 dark:text-white" id="hud-speed">0</div>
                        <div class="text-[10px] text-gray-500 dark:text-gray-400 uppercase">km/h</div>
                    </div>
                    <!-- Espacio central para el boucher -->
                    <div class="flex items-center justify-center">
                        <div class="text-gray-400 opacity-20">
                            <i class="fa-solid fa-ellipsis"></i>
                        </div>
                    </div>
                    <div class="hud-panel p-3 text-center">
                        <i class="fa-solid fa-route text-gray-400 mb-1"></i>
                        <div class="text-lg font-bold text-gray-800 dark:text-white" id="hud-dist">0</div>
                        <div class="text-[10px] text-gray-500 dark:text-gray-400 uppercase">km Recorridos</div>
                    </div>
                </div>
            </div>

            <!-- BOUCHER ASOMÁNDOSE (INFERIOR CENTRO) -->
            <div id="flight-boucher" class="boucher-peek">
                <div class="boucher-content">
                    <!-- Handle / Parte visible -->
                    <div class="boucher-handle-line"></div>
                    <div class="flex flex-col items-center justify-center mb-4 border-b border-dashed border-gray-200 dark:border-gray-700 pb-3 cursor-pointer">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-ticket text-[#0077b6] dark:text-[#38bdf8]"></i>
                            <span class="text-[10px] font-black uppercase tracking-widest text-gray-400">Boarding Pass</span>
                        </div>
                    </div>
                    
                    <!-- Contenido del Boucher -->
                    <div class="flex justify-between items-center mb-4 px-2">
                        <div class="text-center">
                            <div class="text-2xl font-black text-gray-800 dark:text-white" id="boucher-origin">---</div>
                            <div class="text-[10px] text-gray-500 uppercase font-bold">Origen</div>
                        </div>
                        <div class="flex-1 px-4 flex flex-col items-center">
                            <i class="fa-solid fa-plane text-sm text-[#0077b6] dark:text-[#38bdf8]"></i>
                            <div class="w-full h-px bg-gray-300 dark:bg-gray-600 my-1 relative">
                                <div class="absolute w-1 h-1 rounded-full left-0 top-1/2 -translate-y-1/2 bg-gray-300 dark:bg-gray-600"></div>
                                <div class="absolute w-1 h-1 rounded-full right-0 top-1/2 -translate-y-1/2 bg-gray-300 dark:bg-gray-600"></div>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-black text-gray-800 dark:text-white" id="boucher-dest">---</div>
                            <div class="text-[10px] text-gray-500 uppercase font-bold">Destino</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 mt-2">
                        <div class="bg-gray-50 dark:bg-gray-800/50 p-2 rounded-lg text-center border border-gray-100 dark:border-gray-700">
                            <div class="text-[8px] text-gray-400 uppercase font-bold">Vuelo</div>
                            <div class="text-xs font-bold text-gray-700 dark:text-gray-200" id="boucher-duration">--:--</div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-800/50 p-2 rounded-lg text-center border border-gray-100 dark:border-gray-700">
                            <div class="text-[8px] text-gray-400 uppercase font-bold">Arribo</div>
                            <div class="text-xs font-bold text-gray-700 dark:text-gray-200" id="boucher-arrival">--:--</div>
                            <div class="text-[8px] text-gray-500" id="boucher-arrival-date">--/--</div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-800/50 p-2 rounded-lg text-center border border-gray-100 dark:border-gray-700">
                            <div class="text-[8px] text-gray-400 uppercase font-bold">Asiento</div>
                            <div class="text-xs font-bold text-gray-700 dark:text-gray-200">12A</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FLYPER LOGO (BOTTOM-LEFT) -->
            <div class="absolute bottom-5 left-5 z-[95] pointer-events-none">
                <div class="flyper-logo-map">
                    <img src="src/FLYPER_LOGO.svg" class="w-10 h-10 object-contain logo-blue" alt="Flyper Logo">
                </div>
            </div>
        </div>

        <!-- MODAL RESUMEN (OCULTO) -->
        <div id="summary-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-opacity">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center transform transition-all scale-100 border border-gray-200 dark:border-gray-700">
                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-500">
                    <i class="fa-solid fa-plane-arrival text-2xl"></i>
                </div>
                <h2 id="summary-title" class="text-2xl font-black text-gray-800 dark:text-white mb-2">¡Vuelo Completado!</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Resumen de tu sesión de estudio</p>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-xl">
                        <div class="text-xs text-gray-400 uppercase">Tiempo</div>
                        <div class="font-mono font-bold text-gray-800 dark:text-white text-lg" id="summary-time">00:00</div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-xl">
                        <div class="text-xs text-gray-400 uppercase">Distancia</div>
                        <div class="font-bold text-gray-800 dark:text-white text-lg" id="summary-dist">0 km</div>
                    </div>
                </div>
                
                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl mb-6 text-left">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-xs text-blue-500 dark:text-blue-400 uppercase font-bold">Tareas Completadas</div>
                        <span class="text-xs font-bold text-blue-700 dark:text-blue-300" id="summary-task-count">0/0</span>
                    </div>
                    <div class="flex items-center gap-2 w-full">
                        <div class="flex-1 bg-gray-200 dark:bg-gray-700 h-2 rounded-full overflow-hidden w-full">
                            <div id="summary-task-bar" class="bg-blue-500 h-full w-0 transition-all duration-500"></div>
                        </div>
                    </div>
                </div>

                <button onclick="resetApp()" class="w-full bg-blue-600 dark:bg-blue-500 text-white font-black py-4 rounded-2xl shadow-xl hover:scale-[1.03] active:scale-95 transition-all text-lg">
                    Planificar Nuevo Vuelo
                </button>
            </div>
        </div>

        <!-- MODAL CONFIRMACIÓN CANCELAR (NUEVO) -->
        <div id="confirm-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-opacity">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center border border-gray-200 dark:border-gray-700">
                <div class="w-16 h-16 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-yellow-600 dark:text-yellow-400">
                    <i class="fa-solid fa-triangle-exclamation text-2xl"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-2">¿Abortar Vuelo?</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">El progreso actual se guardará hasta este punto, pero no llegarás a tu destino.</p>
                
                <div class="flex gap-3">
                    <button onclick="closeConfirmModal()" class="flex-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold py-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                        Continuar
                    </button>
                    <button onclick="executeCancellation()" class="flex-1 bg-red-500 text-white font-bold py-3 rounded-xl hover:bg-red-600 transition">
                        Terminar
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL TAREAS COMPLETADAS (NUEVO) -->
        <div id="tasks-done-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-opacity">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center border border-gray-200 dark:border-gray-700">
                <div class="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600 dark:text-green-400">
                    <i class="fa-solid fa-check-double text-2xl"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-2">¡Tareas Finalizadas!</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Has completado todas tus tareas. ¿Deseas terminar el vuelo ahora y ver tu resumen?</p>
                
                <div class="flex gap-3">
                    <button onclick="document.getElementById('tasks-done-modal').classList.add('hidden')" class="flex-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold py-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                        Seguir Volando
                    </button>
                    <button onclick="executeCancellation()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">
                        Terminar Vuelo
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL ÉXITO FINAL (NUEVO) -->
        <div id="success-modal" class="hidden fixed inset-0 z-[300] flex items-center justify-center bg-black/60 backdrop-blur-md p-4 transition-opacity">
            <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-sm w-full p-8 text-center border border-gray-200 dark:border-gray-700">
                <div class="w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600 dark:text-green-400">
                    <i class="fa-solid fa-trophy text-4xl"></i>
                </div>
                <h2 class="text-3xl font-black text-gray-800 dark:text-white mb-2">¡Felicidades!</h2>
                <p class="text-gray-500 dark:text-gray-400 mb-8">Has completado todas tus misiones con éxito. ¡Vuelo impecable!</p>
                
                <div class="flex flex-col gap-3">
                    <button onclick="resetApp()" class="w-full bg-gray-900 dark:bg-white dark:text-gray-900 text-white font-black py-4 rounded-2xl shadow-lg transform transition hover:scale-[1.02]">
                        Siguiente Vuelo
                    </button>
                    <button onclick="showFinalSummary()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-2xl shadow-lg transform transition hover:scale-[1.02]">
                        Ver Resumen
                    </button>
                </div>
            </div>
        </div>

        <!-- TOAST NOTIFICATION -->
        <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-[1000] hidden transition-opacity duration-300 pointer-events-none">
            <div class="glass-panel px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 border border-gray-200 dark:border-gray-700">
                <i id="toast-icon" class="fa-solid fa-check-circle text-green-500"></i>
                <span id="toast-msg" class="font-bold text-gray-800 dark:text-white text-sm">Notificación</span>
            </div>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="src/achievements.js"></script>
    <script>
        // --- UTILS ---
        function setUIVisibility(show) {
            if (show) {
                document.body.classList.remove('hide-ui');
            } else {
                document.body.classList.add('hide-ui');
            }
        }

        function escapeHTML(str) {
            if (!str) return "";
            return str.replace(/[&<>'"]/g, 
                tag => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    "'": '&#39;',
                    '"': '&quot;'
                }[tag])
            );
        }

        // --- THEME & MAP LOGIC ---
        let isDarkMode = false;
        let map = null, tileLayer = null, labelLayer = null;
        let flightPolyline = null, planeMarker = null, timerInterval = null;
        let lastSaveTime = 0;

        let usedPause = false;
        let trip = {
            origin: null,
            dest: null,
            distance: 0,
            durationMs: 0,
            startTime: 0,
            sessionName: '',
            tasks: [] 
        };

        function toggleTheme() {
            const html = document.documentElement;
            isDarkMode = !isDarkMode;
            html.classList.toggle('dark', isDarkMode);
            localStorage.theme = isDarkMode ? 'dark' : 'light';
            if (map) updateMapTiles();
        }

        function updateMapTiles() {
            if (!map) return;
            if (tileLayer) map.removeLayer(tileLayer);
            if (labelLayer) map.removeLayer(labelLayer);

            const url = isDarkMode 
                ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png';
            
            const tileOptions = { 
                maxZoom: 18, 
                subdomains: 'abcd',
                noWrap: true,
                bounds: [[-90, -180], [90, 180]]
            };

            tileLayer = L.tileLayer(url, tileOptions).addTo(map);
            if (!isDarkMode) {
                labelLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', tileOptions).addTo(map);
            }
        }
        
        function showError(title, msg) {
             showToast(title + ": " + msg, "error");
        }

        function updateTaskPercent(id, newPercent) {
            const task = trip.tasks.find(t => t.id === id);
            if (task) {
                const val = parseInt(newPercent) || 0;
                const otherTasksTotal = trip.tasks.filter(t => t.id !== id).reduce((sum, t) => sum + t.percent, 0);
                
                if (otherTasksTotal + val > 100) {
                    showError("Límite de Tiempo", "El tiempo total de las tareas no puede superar el 100% del vuelo. Ajusta otras tareas primero.");
                    renderFlightTasks();
                    return;
                }

                task.percent = val;
                renderFlightTasks();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const flightList = document.getElementById('flight-tasks-container');
            new Sortable(flightList, {
                handle: '.flight-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    const newOrder = [];
                    flightList.querySelectorAll('.flight-task-item').forEach(item => {
                        const id = item.dataset.id;
                        const task = trip.tasks.find(t => t.id === id);
                        if(task) newOrder.push(task);
                    });
                    trip.tasks = newOrder;
                    
                    // Clear anchors on reorder to ensure the new top task starts fresh
                    trip.tasks.forEach(t => delete t.startAnchor);
                    
                    saveFlightState();
                    updateActiveTaskHUD(getFlightProgress());
                }
            });
            
            // Check theme
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                isDarkMode = true;
            } else {
                document.documentElement.classList.remove('dark');
                isDarkMode = false;
            }

            // Reducir volumen de efectos de sonido
            document.getElementById('sfx-success').volume = 0.4;
            document.getElementById('sfx-overtime').volume = 0.4;
            document.getElementById('sfx-achievement').volume = 0.4;

            // RESPONSIVE INIT: Ensure menus are closed on mobile
            if (window.innerWidth < 1024) {
                const musicMenu = document.getElementById('music-menu');
                if (musicMenu) musicMenu.classList.remove('open');
            }
        });

        // --- FLIGHT TASK PANEL LOGIC ---
        function toggleTaskList() {
            const menu = document.getElementById('flight-task-list');
            const musicMenu = document.getElementById('music-menu');
            const activeHUD = document.getElementById('active-task-hud');
            const isDesktop = window.innerWidth >= 1024;
            
            if (!isDesktop) {
                if (musicMenu) musicMenu.classList.remove('open');
                if (activeHUD) activeHUD.classList.remove('open');
            }

            if (menu) menu.classList.toggle('open');
            renderFlightTasks();
        }

        function toggleActiveTaskMenu() {
            const menu = document.getElementById('active-task-hud');
            const taskList = document.getElementById('flight-task-list');
            const musicMenu = document.getElementById('music-menu');
            const btn = document.getElementById('btn-active-task-toggle');
            const isDesktop = window.innerWidth >= 1024;

            if (!isDesktop) {
                if (taskList) taskList.classList.remove('open');
                if (musicMenu) musicMenu.classList.remove('open');
            }

            if (menu) menu.classList.toggle('open');
        }

        function renderFlightTasks() {
            const container = document.getElementById('flight-tasks-container');
            container.innerHTML = '';

            trip.tasks.forEach(task => {
                const el = document.createElement('div');
                el.className = `flight-task-item p-3 rounded-lg border text-sm ${
                    task.completed 
                    ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800' 
                    : 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-600'
                }`;
                el.dataset.id = task.id;
                
                el.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="flight-handle cursor-grab text-gray-400 hover:text-gray-600">
                                <i class="fa-solid fa-grip-vertical"></i>
                            </div>
                            <button onclick="toggleTaskComplete('${task.id}')" class="text-lg ${task.completed ? 'text-green-500' : 'text-gray-300 hover:text-gray-500'}">
                                <i class="fa-${task.completed ? 'solid' : 'regular'} fa-circle-check"></i>
                            </button>
                            <span class="${task.completed ? 'line-through text-gray-400' : 'text-gray-800 dark:text-gray-200 font-medium'}">
                                ${escapeHTML(task.title)}
                            </span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleTaskEditMenu('${task.id}')" class="text-gray-400 hover:text-blue-500 p-1">
                                <i class="fa-solid fa-chevron-down transition-transform duration-300" id="chevron-${task.id}"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="edit-menu-${task.id}" class="flight-task-edit-menu border-t border-gray-100 dark:border-gray-700 pt-2">
                        <div class="flex justify-end">
                            <button onclick="deleteTaskInFlight('${task.id}')" class="text-red-400 hover:text-red-600 text-xs flex items-center gap-1">
                                <i class="fa-solid fa-trash"></i> Eliminar Tarea
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });

            checkTasksStatus();
        }

        function addTaskInFlight() {
            const input = document.getElementById('flight-task-input');
            const title = input.value.trim();

            if (!title) return;

            const totalFlightMins = Math.round(trip.durationMs / 60000);
            const currentTotalPct = trip.tasks.reduce((sum, t) => sum + t.percent, 0);
            
            // Calculate % needed for 30 mins (25+5)
            const pctNeeded = (30 / totalFlightMins) * 100;
            
            if (currentTotalPct + pctNeeded > 100) {
                showError("Sin Espacio", "No hay tiempo suficiente en el vuelo para un bloque Pomodoro completo (30m).");
                return;
            }

            // Add Focus
            trip.tasks.push({
                id: Date.now().toString(),
                title: title,
                percent: (25 / totalFlightMins) * 100,
                type: 'focus',
                completed: false
            });

            // Add Break
            trip.tasks.push({
                id: (Date.now() + 1).toString(),
                title: "Pausa / Descanso",
                percent: (5 / totalFlightMins) * 100,
                type: 'break',
                completed: false
            });
            
            input.value = '';
            renderFlightTasks();
            showToast("Bloque Pomodoro añadido", "success");
        }

        function showFinalSummary() {
            document.getElementById('success-modal').classList.add('hidden');
            executeCancellation();
        }

        function checkTasksStatus() {
            if (trip.tasks.length > 0 && trip.tasks.every(t => t.completed)) {
                // TERMINAR VUELO (Tareas Completas)
                setUIVisibility(false);
                clearInterval(timerInterval);
                stopMusic();
                
                // Celebración
                const duration = 5 * 1000;
                const animationEnd = Date.now() + duration;
                const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 400 };

                const randomInRange = (min, max) => Math.random() * (max - min) + min;

                const interval = setInterval(function() {
                    const timeLeft = animationEnd - Date.now();

                    if (timeLeft <= 0) {
                        return clearInterval(interval);
                    }

                    const particleCount = 50 * (timeLeft / duration);
                    confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                    confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
                }, 250);

                const sfx = document.getElementById('sfx-success');
                if (sfx) {
                    sfx.currentTime = 0;
                    sfx.play().catch(e => console.log("Audio block"));
                }

                // Mostrar Resumen Final
                setTimeout(() => {
                    // Llamamos a executeCancellation con forceSuccess=true para guardar stats
                    executeCancellation(true); 
                    
                    // SOBRESCRIBIMOS el título para que NO diga "Destino Alcanzado"
                    const titleEl = document.getElementById('summary-title');
                    if (titleEl) titleEl.innerText = "¡Tareas Finalizadas!";
                    
                    document.getElementById('summary-modal').classList.remove('hidden');
                }, 2000);
            }
        }

        function toggleTaskEditMenu(id) {
            const menu = document.getElementById(`edit-menu-${id}`);
            const chevron = document.getElementById(`chevron-${id}`);
            if (menu) {
                const isOpen = menu.classList.toggle('open');
                if (chevron) {
                    chevron.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
                }
            }
        }

        function deleteTaskInFlight(id) {
            trip.tasks = trip.tasks.filter(t => t.id !== id);
            renderFlightTasks();
        }

        function toggleTaskComplete(id) {
            const taskIndex = trip.tasks.findIndex(t => t.id === id);
            if (taskIndex !== -1) {
                const task = trip.tasks[taskIndex];
                task.completed = !task.completed;
                
                if (task.completed) {
                    confetti({
                        particleCount: 150,
                        spread: 70,
                        origin: { y: 0.6 },
                        zIndex: 200
                    });

                    const sfx = document.getElementById('sfx-success');
                    if (sfx) {
                        sfx.currentTime = 0;
                        sfx.play().catch(e => console.log("Audio play blocked"));
                    }
                    
                    // Reset anchor of the next task so it starts counting from NOW
                    // (Visual Continuity Fix)
                    const nextTask = trip.tasks.find((t, i) => i > taskIndex && !t.completed); // Simple find next uncompleted
                    // Actually, trip.tasks.find(!completed) in updateActiveTaskHUD will find the correct one.
                    // We just need to ensure it doesn't have a stale anchor if we are toggling back and forth.
                    // It's safer to clear anchors of ALL subsequent uncompleted tasks? 
                    // No, just the one that becomes active. 
                    // Let's iterate and clear anchors for all uncompleted tasks to be safe against reordering/toggling.
                    trip.tasks.forEach(t => {
                        if (!t.completed) delete t.startAnchor;
                    });
                } else {
                    // If untoggling, also clear anchors to let it re-sync
                     trip.tasks.forEach(t => {
                        if (!t.completed) delete t.startAnchor;
                    });
                }

                renderFlightTasks();
                updateActiveTaskHUD(getFlightProgress());
            }
        }


        // --- ACHIEVEMENTS & STATS LOGIC ---
        function getStats() {
            const defaultStats = {
                totalFlightTime: 0,
                totalFlights: 0,
                abortedFlights: 0,
                airportsVisited: [],
                currentStreak: 0,
                longestStreak: 0,
                lastFlightDate: null,
                perfectFlights: 0,
                flightsWithoutPause: 0,
                longestSingleFlight: 0,
                flightsByHour: {},
                sharedPlans: 0,
                savedItineraries: 0
            };
            return { ...defaultStats, ...JSON.parse(localStorage.getItem('flyper_stats') || "{}") };
        }

        function saveStats(stats) {
            localStorage.setItem('flyper_stats', JSON.stringify(stats));
        }

        function incrementAbortedFlights() {
            const stats = getStats();
            stats.abortedFlights = (stats.abortedFlights || 0) + 1;
            saveStats(stats);
        }

        function getUnlockedAchievements() {
            return JSON.parse(localStorage.getItem('flyper_achievements')) || {};
        }

        function saveUnlockedAchievements(unlocked) {
            localStorage.setItem('flyper_achievements', JSON.stringify(unlocked));
        }

        function updateStatsOnFlightComplete(completedTrip, pauseUsed) {
            const stats = getStats();
            
            stats.totalFlights++;
            stats.totalFlightTime += Math.round(completedTrip.durationMs / 60000);
            
            if (!stats.airportsVisited.includes(completedTrip.origin.code)) stats.airportsVisited.push(completedTrip.origin.code);
            if (!stats.airportsVisited.includes(completedTrip.dest.code)) stats.airportsVisited.push(completedTrip.dest.code);

            const allTasksDone = completedTrip.tasks.length > 0 && completedTrip.tasks.every(t => t.completed);
            if (allTasksDone) stats.perfectFlights++;
            if (!pauseUsed) stats.flightsWithoutPause++;
            
            const flightMins = Math.round(completedTrip.durationMs / 60000);
            if (flightMins > stats.longestSingleFlight) stats.longestSingleFlight = flightMins;

            if (!stats.flightsByHour) stats.flightsByHour = {};
            const hour = new Date().getHours().toString();
            stats.flightsByHour[hour] = (stats.flightsByHour[hour] || 0) + 1;

            updateStreak(stats);

            saveStats(stats);
            checkAchievements(stats);
        }

        function updateStreak(stats) {
            const today = new Date().toDateString();
            const lastDate = stats.lastFlightDate ? new Date(stats.lastFlightDate).toDateString() : null;

            if (today === lastDate) return; 

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (lastDate === yesterday.toDateString()) {
                stats.currentStreak++;
            } else {
                stats.currentStreak = 1;
            }

            if (stats.currentStreak > stats.longestStreak) {
                stats.longestStreak = stats.currentStreak;
            }
            
            stats.lastFlightDate = new Date().toISOString();
        }

        function checkAchievements(stats) {
            const unlocked = getUnlockedAchievements();
            const newUnlocks = [];

            for (const key in ACHIEVEMENTS) {
                if (unlocked[key]) continue;

                const achievement = ACHIEVEMENTS[key];
                if (achievement.condition(stats)) {
                    unlocked[key] = new Date().toISOString();
                    newUnlocks.push(achievement);
                    showAchievementUnlocked(achievement);
                }
            }

            if (newUnlocks.length > 0) {
                saveUnlockedAchievements(unlocked);
            }
        }

        function showAchievementUnlocked(achievement) {
            const sfx = document.getElementById('sfx-achievement');
            if (sfx) {
                sfx.currentTime = 0;
                sfx.play().catch(e => {});
            }

            showToast(`¡Logro Desbloqueado: ${achievement.name}!`, "success");
        }

        // --- INIT & CORE LOGIC ---
        window.onload = () => { 
            if (restoreFlightState()) {
                initMap();
            } else {
                window.location.href = 'plan.html';
            }
        };

        function formatTime(mins) {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return h > 0 ? `${h}h ${m}m` : `${m} min`;
        }

        // --- NEW CANCELLATION LOGIC ---
        function cancelFlight() {
            setUIVisibility(false);
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            setUIVisibility(true);
            document.getElementById('confirm-modal').classList.add('hidden');
        }

        function executeCancellation(forceSuccess = false) {
            clearFlightState();
            setUIVisibility(false);
            document.getElementById('confirm-modal').classList.add('hidden');
            document.getElementById('tasks-done-modal').classList.add('hidden');
            
            clearInterval(timerInterval);
            stopMusic();

            const now = Date.now();
            const elapsedMs = (now - trip.startTime) - totalPausedTime;
            
            const elapsedMins = Math.floor(elapsedMs / 60000);
            const elapsedHrs = Math.floor(elapsedMins / 60);
            const remainingMins = elapsedMins % 60;
            
            const progress = Math.min(1, elapsedMs / trip.durationMs);
            const distCovered = Math.floor(trip.distance * progress);
            
            const totalTasks = trip.tasks.length;
            const completedTasks = trip.tasks.filter(t => t.completed).length;
            const taskPct = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;

            const isArrival = progress >= 0.99 || forceSuccess;
            const allTasksDone = totalTasks > 0 && completedTasks === totalTasks;
            const titleEl = document.getElementById('summary-title');
            
            if (!isArrival && !forceSuccess) {
                incrementAbortedFlights();
            }
            
            if (titleEl) {
                if (isArrival || forceSuccess) {
                    titleEl.innerText = "¡Destino Alcanzado!";
                } else if (allTasksDone) {
                    titleEl.innerText = "Resumen de tu Vuelo";
                } else {
                    titleEl.innerText = "Vuelo Interrumpido";
                }
            }

            document.getElementById('summary-time').innerText = `${elapsedHrs > 0 ? elapsedHrs + 'h ' : ''}${remainingMins}m`;
            document.getElementById('summary-dist').innerText = `${distCovered} km`;
            document.getElementById('summary-task-count').innerText = `${completedTasks}/${totalTasks}`;
            document.getElementById('summary-task-bar').style.width = `${taskPct}%`;

            if (map) { 
                map.remove(); 
                map = null; 
                tileLayer = null; 
                labelLayer = null; 
            }

            document.getElementById('summary-modal').classList.remove('hidden');

            const sfx = document.getElementById('sfx-success');
            if (sfx) {
                sfx.currentTime = 0;
                sfx.play().catch(e => console.log("Audio block"));
            }
        }

        function resetApp() {
            window.location.href = 'plan.html';
        }

        // --- MUSIC LOGIC ---
        function toggleMusicMenu() { 
            const menu = document.getElementById('music-menu');
            const taskList = document.getElementById('flight-task-list');
            const activeHUD = document.getElementById('active-task-hud');
            const isDesktop = window.innerWidth >= 1024;

            if (!isDesktop) {
                if (taskList) taskList.classList.remove('open');
                if (activeHUD) activeHUD.classList.remove('open');
            }

            if (menu) menu.classList.toggle('open'); 
        }

        function playTrack(url, element) {
            const player = document.getElementById('audio-player');
            const btn = document.getElementById('btn-music-toggle');
            const icon = document.getElementById('music-icon');
            const waves = document.getElementById('music-waves');
            const wavesBars = document.querySelectorAll('.wave-bar');
            
            const volSlider = document.getElementById('volume-slider');
            const currentVol = volSlider ? parseFloat(volSlider.value) : 0.5;

            document.querySelectorAll('.track-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');

            player.src = url;
            player.volume = currentVol; 
            player.play().catch(e => console.log("Interaction needed"));

            btn.classList.add('active', 'playing');
            icon.style.display = 'none';
            waves.style.display = 'flex';
            wavesBars.forEach(bar => bar.style.display = 'block');
        }

        function changeVolume(val) {
            document.getElementById('audio-player').volume = val;
            document.getElementById('vol-label').innerText = Math.round(val * 100) + '%';
        }

        function stopMusic() {
            const player = document.getElementById('audio-player');
            const btn = document.getElementById('btn-music-toggle');
            const icon = document.getElementById('music-icon');
            const waves = document.getElementById('music-waves');

            player.pause();
            player.currentTime = 0;
            document.querySelectorAll('.track-item').forEach(el => el.classList.remove('selected'));
            btn.classList.remove('active', 'playing');
            icon.style.display = 'block';
            waves.style.display = 'none';
            setTimeout(() => { document.getElementById('music-menu').classList.remove('open'); }, 200);
        }

        // --- FLIGHT PERSISTENCE LOGIC ---
        function saveFlightState() {
            if (!trip.startTime) return;
            const now = Date.now();
            const elapsed = (now - trip.startTime) - totalPausedTime;
            
            const state = {
                trip: trip,
                elapsed: elapsed,
                timestamp: now
            };
            localStorage.setItem('flyper_active_flight', JSON.stringify(state));
        }

        function clearFlightState() {
            localStorage.removeItem('flyper_active_flight');
        }

        function restoreFlightState() {
            const saved = localStorage.getItem('flyper_active_flight');
            if (!saved) return false;

            try {
                const state = JSON.parse(saved);
                if (!state.trip || !state.trip.origin || !state.trip.dest) {
                    clearFlightState();
                    return false;
                }

                trip = state.trip;
                
                // If restore logic needs to account for time elapsed since page load or pause, 
                // we treat the reload as a continuation.
                // However, user might have just refreshed.
                // state.elapsed is the time FLOWN.
                trip.startTime = Date.now() - state.elapsed;

                updateFlightDisplays(); 

                return true;
            } catch (e) {
                console.error("Error restoring flight:", e);
                clearFlightState();
                return false;
            }
        }

        function updateFlightDisplays() {
            const listTitle = document.getElementById('flight-list-session-name');
            if (listTitle) listTitle.innerText = trip.sessionName;

            document.getElementById('boucher-origin').innerText = trip.origin.code;
            document.getElementById('boucher-dest').innerText = trip.dest.code;
            document.getElementById('boucher-duration').innerText = formatTime(Math.round(trip.durationMs / 60000));

            const arrivalDate = new Date(trip.startTime + trip.durationMs);
            const arrivalTime = arrivalDate.getHours().toString().padStart(2, '0') + ":" + arrivalDate.getMinutes().toString().padStart(2, '0');
            const arrivalDateStr = arrivalDate.getDate().toString().padStart(2, '0') + "/" + (arrivalDate.getMonth() + 1).toString().padStart(2, '0');
            const arrivalFullDate = arrivalDateStr + "/" + arrivalDate.getFullYear().toString().substr(-2);
            
            const boucherArrival = document.getElementById('boucher-arrival');
            if (boucherArrival) boucherArrival.innerText = arrivalTime;
            const boucherArrivalDate = document.getElementById('boucher-arrival-date');
            if (boucherArrivalDate) boucherArrivalDate.innerText = arrivalDateStr;
            
            const hudArrival = document.getElementById('hud-arrival');
            if (hudArrival) hudArrival.innerText = arrivalTime;
            const hudArrivalDate = document.getElementById('hud-arrival-date');
            if (hudArrivalDate) hudArrivalDate.innerText = arrivalFullDate;
            
            // Re-apply layout for desktop/mobile
            const isDesktop = window.innerWidth >= 1024;
            const btn = document.getElementById('btn-active-task-toggle');
            const hud = document.getElementById('active-task-hud');
            const taskList = document.getElementById('flight-task-list');

            if (isDesktop) {
                if (hud && trip.tasks.length > 0) hud.classList.add('open');
                if (taskList) taskList.classList.add('open');
                if (btn) btn.classList.add('button-glow');
            } else {
                if (btn) btn.classList.add('button-glow');
            }
        }

        function showToast(msg, type = "success") {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            const iconEl = document.getElementById('toast-icon');

            msgEl.innerText = msg;
            if (type === "success") {
                iconEl.className = "fa-solid fa-check-circle text-green-500";
            } else {
                iconEl.className = "fa-solid fa-circle-exclamation text-red-500";
            }

            toast.classList.remove('hidden');
            toast.classList.remove('opacity-0');
            
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => {
                    toast.classList.add('hidden');
                    toast.classList.remove('opacity-0'); 
                }, 300);
            }, 3000);
        }

        // --- PAUSE LOGIC ---
        let isPaused = false;
        let totalPausedTime = 0;
        let pauseStartTime = 0;
        let pauseInterval = null;
        let pauseEndTime = 0;

        function togglePauseMenu() {
            const menu = document.getElementById('pause-menu');
            const taskList = document.getElementById('flight-task-list');
            const musicMenu = document.getElementById('music-menu');
            const activeHUD = document.getElementById('active-task-hud');
            const isDesktop = window.innerWidth >= 1024;
            
            if (!isDesktop) {
                if (taskList) taskList.classList.remove('open');
                if (musicMenu) musicMenu.classList.remove('open');
                if (activeHUD) activeHUD.classList.remove('open');
            }

            if (menu) menu.classList.toggle('open');
        }

        function startPause(minutes) {
            isPaused = true;
            usedPause = true;
            togglePauseMenu(); 
            
            clearInterval(timerInterval);
            
            pauseStartTime = Date.now();
            pauseEndTime = Date.now() + minutes * 60000;
            
            document.getElementById('pause-overlay').classList.remove('hidden');
            updatePauseLoop(); 
            pauseInterval = setInterval(updatePauseLoop, 1000);
        }

        function updatePauseLoop() {
            const now = Date.now();
            const remaining = Math.max(0, pauseEndTime - now);
            
            if (remaining <= 0) {
                const sfx = document.getElementById('sfx-overtime');
                if (sfx) {
                    sfx.currentTime = 0;
                    sfx.play().catch(e => console.log("Audio block"));
                }
                resumeFlight();
                return;
            }
            
            const mins = Math.floor(remaining / 60000);
            const secs = Math.floor((remaining % 60000) / 1000);
            document.getElementById('pause-countdown').innerText = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function resumeFlight() {
            if (!isPaused) return;
            
            clearInterval(pauseInterval);
            const pauseDuration = Date.now() - pauseStartTime;
            totalPausedTime += pauseDuration;
            
            // Mark the auto-pause task as completed if it was the trigger
            if (lastTriggeredBreakId) {
                const breakTask = trip.tasks.find(t => t.id === lastTriggeredBreakId);
                if (breakTask) {
                    breakTask.completed = true;
                    renderFlightTasks(); // Update UI checkmark
                }
            }
            
            isPaused = false;
            document.getElementById('pause-overlay').classList.add('hidden');
            
            timerInterval = setInterval(loopFlight, 1000);
        }

        // --- MAP ENGINE & LOOP ---
        function initMap() {
            setTimeout(() => {
                if (map) map.remove();
                map = L.map('map', { 
                    zoomControl: false, 
                    attributionControl: false,
                    minZoom: 2,
                    maxBounds: [[-90, -180], [90, 180]],
                    maxBoundsViscosity: 1.0,
                    scrollWheelZoom: true,
                    doubleClickZoom: true,
                    touchZoom: true,
                    dragging: true
                });
                updateMapTiles();

                const oLatLon = [trip.origin.lat, trip.origin.lon];
                const dLatLon = [trip.dest.lat, trip.dest.lon];

                L.polyline([oLatLon, dLatLon], { color: '#0ea5e9', weight: 3, opacity: 0.6, dashArray: '10, 10' }).addTo(map);
                L.circleMarker(oLatLon, { radius: 5, color: '#0ea5e9', fillOpacity: 1 }).addTo(map);
                L.circleMarker(dLatLon, { radius: 5, color: '#ef4444', fillOpacity: 1 }).addTo(map);

                map.fitBounds([oLatLon, dLatLon], { padding: [50, 50] });
                
                const planeIcon = L.divIcon({
                    className: 'plane-div',
                    html: `<i class="fa-solid fa-plane text-3xl plane-icon" style="display:block;"></i>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                planeMarker = L.marker(oLatLon, { icon: planeIcon }).addTo(map);

                renderFlightTasks(); 
                timerInterval = setInterval(loopFlight, 1000);
            }, 300);
        }

        function getFlightProgress() {
            if (!trip.startTime) return 0;
            const now = Date.now();
            const elapsed = (now - trip.startTime) - totalPausedTime;
            let progress = elapsed / trip.durationMs;
            return progress > 1 ? 1 : progress;
        }

        function loopFlight() {
            let progress = getFlightProgress();

            if (progress >= 1) {
                progress = 1;
                clearInterval(timerInterval);
                finishFlight();
                return;
            }

            const now = Date.now();
            const elapsed = (now - trip.startTime) - totalPausedTime;
            const remaining = Math.max(0, trip.durationMs - elapsed);
            
            document.getElementById('hud-timer').innerText = new Date(remaining).toISOString().substr(11, 8);
            document.getElementById('hud-pct').innerText = Math.floor(progress * 100) + "%";
            document.getElementById('hud-dist').innerText = Math.floor(trip.distance * progress);
            
            const spd = progress >= 1 ? 0 : 850 + Math.floor(Math.random() * 20 - 10);
            document.getElementById('hud-speed').innerText = spd;

            const lat = trip.origin.lat + (trip.dest.lat - trip.origin.lat) * progress;
            const lon = trip.origin.lon + (trip.dest.lon - trip.origin.lon) * progress;
            planeMarker.setLatLng([lat, lon]);

            const p1 = map.latLngToContainerPoint([trip.origin.lat, trip.origin.lon]);
            const p2 = map.latLngToContainerPoint([trip.dest.lat, trip.dest.lon]);
            const angleDeg = Math.atan2(p2.y - p1.y, p2.x - p1.x) * 180 / Math.PI;
            const icon = document.querySelector('.plane-icon');
            if(icon) icon.style.transform = `rotate(${angleDeg}deg)`; 

            if (now - lastSaveTime > 10000) {
                saveFlightState();
                lastSaveTime = now;
            }

            updateActiveTaskHUD(progress);
        }

        // Variable to track if we already triggered pause for a specific break task
        let lastTriggeredBreakId = null;

        function toggleTaskDropdown() {
            const dropdown = document.getElementById('top-task-dropdown');
            const chevron = document.getElementById('task-dropdown-chevron');
            
            if (dropdown) {
                if (dropdown.classList.contains('max-h-0')) {
                    // OPEN
                    dropdown.classList.remove('max-h-0', 'opacity-0', 'translate-y-[-10px]');
                    if(chevron) chevron.style.transform = 'rotate(180deg)';
                } else {
                    // CLOSE
                    dropdown.classList.add('max-h-0', 'opacity-0', 'translate-y-[-10px]');
                    if(chevron) chevron.style.transform = 'rotate(0deg)';
                }
            }
        }

        // Alias for compatibility if other functions call it
        function toggleTaskList() {
            toggleTaskDropdown();
        }

        function updateActiveTaskHUD(globalProgress) {
            const barContainer = document.getElementById('top-active-task-bar');
            
            if (trip.tasks.length === 0 || globalProgress >= 1) {
                if (barContainer) barContainer.style.display = 'none';
                return;
            } else {
                if (barContainer) barContainer.style.display = 'flex';
            }

            let currentTask = trip.tasks.find(t => !t.completed);
            
            if (!currentTask) {
                // All done
                document.getElementById('top-bar-title').innerText = "¡Tareas Finalizadas!";
                document.getElementById('top-bar-timer').innerText = "";
                document.getElementById('top-bar-progress').style.width = '100%';
                document.getElementById('task-icon-status').className = "fa-solid fa-check-double";
                return;
            }

            // DYNAMIC ANCHOR LOGIC (Fix for "frozen" tasks)
            // If the task doesn't have a start anchor, or if it's wildly out of sync (e.g. from reordering),
            // we anchor it to the current global progress. This effectively "starts" the task timer NOW.
            if (currentTask.startAnchor === undefined) {
                currentTask.startAnchor = globalProgress;
                // Save state so this anchor persists across reloads
                saveFlightState();
            }

            // AUTO-PAUSE LOGIC
            if (currentTask.type === 'break' && currentTask.id !== lastTriggeredBreakId && !isPaused) {
                lastTriggeredBreakId = currentTask.id;
                const totalFlightMins = Math.round(trip.durationMs / 60000);
                const breakMins = Math.round((currentTask.percent / 100) * totalFlightMins);
                startPause(breakMins); 
                return; 
            }

            // UI UPDATES
            const titleEl = document.getElementById('top-bar-title');
            const statusEl = document.getElementById('top-bar-status');
            const iconEl = document.getElementById('task-icon-status');
            
            titleEl.innerText = currentTask.title;

            if (isPaused) {
                statusEl.innerText = "En Pausa";
                statusEl.classList.add('text-yellow-500');
                iconEl.className = "fa-solid fa-mug-hot";
            } else {
                statusEl.innerText = currentTask.type === 'break' ? "Tiempo de Descanso" : "Tarea Actual";
                statusEl.classList.remove('text-yellow-500');
                iconEl.className = currentTask.type === 'break' ? "fa-solid fa-mug-hot" : "fa-solid fa-person-digging";
            }

            // CALC PROGRESS using Anchor
            const taskDuration = currentTask.percent / 100;
            
            if (taskDuration <= 0) {
                 document.getElementById('top-bar-progress').style.width = '100%';
                 document.getElementById('top-bar-timer').innerText = "0m";
                 return;
            }

            let localProgress = (globalProgress - currentTask.startAnchor) / taskDuration;
            
            // Visual clamping
            if (localProgress < 0) localProgress = 0; // Should not happen with anchor logic, but safe to keep
            // We do allow > 1 for Overtime indication

            const pct = Math.min(100, Math.floor(localProgress * 100));
            document.getElementById('top-bar-progress').style.width = pct + '%';
            
            // Overtime Visuals
            if (localProgress >= 1) {
                if (!barContainer.classList.contains('task-overtime')) {
                    barContainer.classList.add('task-overtime');
                    const sfx = document.getElementById('sfx-overtime');
                    if (sfx) {
                        sfx.currentTime = 0;
                        sfx.play().catch(e => console.log("Audio block"));
                    }
                }
                document.getElementById('top-bar-timer').innerText = "¡TIEMPO!";
            } else {
                barContainer.classList.remove('task-overtime');
                
                const taskTotalMs = trip.durationMs * taskDuration;
                const taskElapsedMs = taskTotalMs * localProgress;
                const taskRemainingMs = taskTotalMs - taskElapsedMs;
                const mins = Math.ceil(taskRemainingMs / 60000);
                document.getElementById('top-bar-timer').innerText = mins + "m";
            }
        }

        function completeCurrentTask() {
            let currentTask = trip.tasks.find(t => !t.completed);
            if (currentTask) {
                toggleTaskComplete(currentTask.id);
            }
        }

        function finishFlight() {
            updateStatsOnFlightComplete(trip, usedPause);

            clearFlightState();
            if (pauseInterval) clearInterval(pauseInterval);
            isPaused = false;
            document.getElementById('pause-overlay').classList.add('hidden');
            
            document.getElementById('hud-timer').innerText = "LLEGADA";
            stopMusic(); 
            
            setTimeout(() => {
                executeCancellation();
            }, 1000);
        }
    </script>
</body>
</html>