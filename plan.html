<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="src/favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flyper - Planificación</title>
    
    <!-- Tailwind CSS with Dark Mode Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            text: '#f8fafc'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Tom Select (Searchable Dropdown) -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* FIX: Asegurar altura completa */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* --- Tom Select Customization (Dark/Light Mode) --- */
        .ts-control {
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            font-weight: 500;
        }
        .ts-control .item {
            color: #1f2937; /* gray-800 */
        }
        html.dark .ts-control .item {
            color: #f3f4f6; /* gray-100 */
        }
        .ts-control input {
            color: #1f2937 !important;
        }
        html.dark .ts-control input {
            color: #f3f4f6 !important;
        }
        
        .ts-dropdown {
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            z-index: 200;
        }
        html.dark .ts-dropdown {
            background-color: #1f2937;
            border: 1px solid #374151;
            color: #f3f4f6;
        }
        .ts-dropdown .option {
            padding: 10px 16px;
        }
        html.dark .ts-dropdown .option {
            color: #e5e7eb;
        }
        .ts-dropdown .option.active, .ts-dropdown .option:hover {
            background-color: #eff6ff; /* blue-50 */
            color: #1d4ed8; /* blue-700 */
        }
        html.dark .ts-dropdown .option.active, html.dark .ts-dropdown .option:hover {
            background-color: #1e3a8a; /* blue-900 */
            color: #60a5fa; /* blue-400 */
        }
        .ts-dropdown .optgroup-header {
            background-color: #f3f4f6;
            color: #6b7280;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        html.dark .ts-dropdown .optgroup-header {
            background-color: #374151;
            color: #9ca3af;
        }

        /* Original Styles */

        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        /* Transiciones de Pantalla */
        .screen {
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .hidden-screen {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            transform: scale(0.95);
        }
        .active-screen {
            opacity: 1;
            pointer-events: auto;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            transform: scale(1);
        }

        /* Ticket Styles */
        .boarding-pass {
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }
        .pass-header {
            background: #0077b6; 
            color: white;
            padding: 1.5rem;
        }
        html.dark .pass-header {
            background: #0ea5e9;
        }
        .pass-body {
            padding: 2rem;
            transition: background-color 0.3s ease;
        }
        .pass-footer {
            padding: 1.5rem;
            border-top: 2px dashed #cbd5e1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        html.dark .pass-footer {
            border-top-color: #475569;
        }

        /* Glass HUD & Buttons */
        .glass-panel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.4));
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.5);
            transition: all 0.3s ease;
        }
        html.dark .glass-panel {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(30, 41, 59, 0.6));
            border: 1px solid rgba(255,255,255,0.1);
            color: #f8fafc;
        }
        
        /* Aplicando estilos glass manualmente a clases específicas con sombras mejoradas */
        .hud-panel, .music-btn, .music-menu, .theme-toggle, .task-panel, .ts-dropdown, .cancel-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.5)) !important;
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            border: 1px solid rgba(255,255,255,0.6) !important;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.2), 0 4px 10px -5px rgba(0, 0, 0, 0.1) !important;
        }
        html.dark .hud-panel, html.dark .music-btn, html.dark .music-menu, html.dark .theme-toggle, html.dark .task-panel, html.dark .ts-dropdown, html.dark .cancel-btn {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.7)) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.5), 0 5px 15px -5px rgba(0, 0, 0, 0.3) !important;
            color: #e2e8f0;
        }

        .theme-toggle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s, color 0.2s;
            color: #334155;
            z-index: 101;
        }
        .theme-toggle:hover {
            transform: scale(1.1);
            background: white;
            color: #0077b6;
        }
        html.dark .theme-toggle:hover {
            background: #1e293b;
            color: #38bdf8;
        }

        /* Estilos específicos para To-Do List */
        .task-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: grab;
        }
        .task-card:active {
            cursor: grabbing;
        }
        .task-card.sortable-ghost {
            opacity: 0.4;
            background: #e2e8f0;
        }
        html.dark .task-card.sortable-ghost {
            background: #334155;
        }

        /* FLYPER Logo Styles */
        .flyper-logo {
            width: 80px; 
            height: auto;
            margin-bottom: 2rem;
            transition: transform 0.3s ease, filter 0.3s ease;
        }

        .flyper-logo img {
            width: 100%;
            height: auto;
            filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.1));
            transition: filter 0.3s ease;
        }

        html.dark .flyper-logo img {
            filter: drop-shadow(0px 0px 12px rgba(56,189,248,0.25));
        }

        .logo-blue {
            filter: invert(31%) sepia(94%) saturate(1125%) hue-rotate(174deg) brightness(92%) contrast(101%);
        }
        
        html.dark .logo-blue {
            filter: invert(72%) sepia(54%) saturate(4244%) hue-rotate(171deg) brightness(101%) contrast(98%);
        }

        .flyper-logo:hover {
            transform: scale(1.03);
        }

        /* Decorative Elements */
        .decorative-bg-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }

        .decorative-circle {
            position: absolute;
            width: 80vh;
            height: 80vh;
            max-width: 90vw;
            max-height: 90vw;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.2), rgba(0, 119, 182, 0.05));
            backdrop-filter: blur(80px);
            -webkit-backdrop-filter: blur(80px);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 100px rgba(14, 165, 233, 0.1);
        }

        /* Noise effect */
        .decorative-circle::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.08;
            z-index: -1;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            border-radius: 50%;
        }

        html.dark .decorative-circle {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(0, 119, 182, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Responsive sizing */
        @media (max-width: 768px) {
            .flyper-logo {
                width: 70px;
            }
            .decorative-circle {
                width: 400px;
                height: 400px;
            }
        }

        @media (max-width: 576px) {
            .flyper-logo {
                width: 60px;
            }
            .decorative-circle {
                width: 300px;
                height: 300px;
            }
            .glass-panel {
                padding: 1.5rem !important;
            }
            #screen-todo .glass-panel {
                height: 90vh;
            }
        }

        /* Prevent text selection */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        input, select, textarea {
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-950 text-gray-800 dark:text-gray-100">

    <audio id="sfx-achievement" src="src/sounds/Sonido%20de%20moneda%20Mario.mp3" preload="auto"></audio>

    <!-- APP CONTAINER -->
    <div id="app" class="relative w-full h-full">

        <!-- PANTALLA 1: PLANIFICADOR (VUELO) -->
        <div id="screen-planner" class="active-screen flex flex-col items-center justify-center p-4 h-full bg-gray-100 dark:bg-gray-950 transition-colors duration-300 overflow-hidden">
            
            <!-- DECORACIÓN DE FONDO -->
            <div class="decorative-bg-container">
                <div class="decorative-circle"></div>
            </div>

            <!-- BOTONES SUPERIORES (DENTRO DEL PLANIFICADOR) -->
            <div class="absolute top-4 right-4 z-50 flex gap-3">
                <button onclick="openStats()" class="theme-toggle flex items-center justify-center gap-2 px-4 w-auto rounded-full" title="Estadísticas">
                    <i class="fa-solid fa-chart-simple text-blue-500"></i>
                    <span class="text-xs font-bold hidden sm:inline">Stats</span>
                </button>
                <button onclick="openAchievements()" class="theme-toggle flex items-center justify-center gap-2 px-4 w-auto rounded-full" title="Logros">
                    <i class="fa-solid fa-trophy text-yellow-500"></i>
                    <span class="text-xs font-bold hidden sm:inline">Trofeos</span>
                </button>
                <button onclick="openHangar()" class="theme-toggle flex items-center justify-center gap-2 px-4 w-auto rounded-full" title="Mis Itinerarios">
                    <i class="fa-solid fa-box-archive"></i>
                    <span class="text-xs font-bold hidden sm:inline">Mis Vuelos</span>
                </button>
                <a href="https://github.com/vicevll/flyper" target="_blank" class="theme-toggle flex items-center justify-center" title="Ver en GitHub">
                    <i class="fa-brands fa-github text-xl"></i>
                </a>
                <button onclick="toggleTheme()" class="theme-toggle" title="Cambiar Tema">
                    <i class="fa-solid fa-moon dark:hidden"></i>
                    <i class="fa-solid fa-sun hidden dark:inline text-yellow-400"></i>
                </button>
            </div>

            <!-- Logo FLYPER -->

            <div class="glass-panel p-8 rounded-3xl shadow-2xl w-full max-w-md relative z-10">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-500/10 dark:bg-blue-400/10 rounded-full mb-4 transition-colors">
                        <img src="src/FLYPER_LOGO.svg" class="w-10 h-10 object-contain logo-blue" alt="Flyper Logo">
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Plan de Vuelo</h1>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">Configura tu sesión de estudio</p>
                </div>

                <div class="space-y-6">
                    <!-- Origen -->
                    <div class="relative">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">1. Aeropuerto de Salida</label>
                        <div class="flex items-center bg-white/50 dark:bg-black/20 border border-white/50 dark:border-white/10 rounded-xl p-1 hover:border-blue-400 transition-colors">
                            <i class="fa-solid fa-plane-departure text-blue-500/50 dark:text-blue-400/50 ml-3 mr-1 w-5 text-center"></i>
                            <select id="origin" class="w-full bg-transparent outline-none text-gray-800 dark:text-white font-medium cursor-pointer" onchange="updatePreview()">
                                <option value="" disabled selected class="dark:bg-gray-800">Seleccionar origen...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Destino -->
                    <div class="relative">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">2. Aeropuerto de Destino</label>
                        <div class="flex items-center bg-white/50 dark:bg-black/20 border border-white/50 dark:border-white/10 rounded-xl p-1 hover:border-blue-400 transition-colors">
                            <i class="fa-solid fa-location-dot text-blue-500/50 dark:text-blue-400/50 ml-3 mr-1 w-5 text-center"></i>
                            <select id="destination" class="w-full bg-transparent outline-none text-gray-800 dark:text-white font-medium cursor-pointer" onchange="updatePreview()">
                                <option value="" disabled selected class="dark:bg-gray-800">Seleccionar destino...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Previsualización -->
                    <div id="preview-box" class="hidden bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-100 dark:border-blue-800 flex justify-between items-center transition-colors">
                        <div>
                            <div class="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wide">Tiempo de Vuelo</div>
                            <div class="text-xl font-bold text-blue-900 dark:text-blue-100" id="preview-time">-- min</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-blue-500 dark:text-blue-400">Distancia</div>
                            <div class="text-sm font-semibold text-blue-800 dark:text-blue-200" id="preview-dist">-- km</div>
                        </div>
                    </div>

                    <!-- Botón siguiente -->
                    <button id="btn-goto-tasks" disabled onclick="showTasksScreen()" class="w-full bg-gray-900 dark:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-black dark:hover:bg-blue-700 transition transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed">
                        Planificar Estudio <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- FOOTER DISFRUTA -->
            <div class="absolute bottom-10 w-full text-center text-gray-400 dark:text-gray-500 text-sm font-medium flex items-center justify-center gap-2 z-10 animate-pulse">
                <span>Disfruta</span>
                <i class="fa-solid fa-heart text-blue-500"></i>
            </div>
        </div>

        <!-- PANTALLA 1.5: TO-DO LIST (PLAN DE ESTUDIO) -->
        <div id="screen-todo" class="hidden-screen flex items-center justify-center p-4 h-full bg-transparent">
            <div class="glass-panel p-6 rounded-3xl shadow-2xl w-full max-w-lg h-[80vh] flex flex-col relative z-10">
                
                <!-- Header -->
                <div class="flex items-center justify-between mb-4">
                    <button onclick="showScreen('screen-planner')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                        <i class="fa-solid fa-arrow-left"></i> Volver
                    </button>
                    <div class="text-center">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white">Plan de Estudio</h2>
                        <span id="todo-total-time" class="text-xs font-mono text-blue-600 dark:text-blue-400 bg-blue-500/10 px-2 py-1 rounded">Total: 0 min</span>
                    </div>
                    <div class="w-10"></div> <!-- Spacer -->
                </div>

                <!-- Session Name Area -->
                <div class="mb-6">
                    <div class="flex items-center gap-2 mb-2 px-1">
                        <i class="fa-solid fa-tag text-blue-500 text-xs"></i>
                        <label class="text-[10px] font-black uppercase tracking-widest text-gray-400 dark:text-gray-500">Nombre de la Misión</label>
                    </div>
                    <input type="text" id="session-name-input" placeholder="Ej: Preparación Examen IA..." 
                           class="w-full bg-blue-500/5 dark:bg-white/5 border-2 border-dashed border-blue-500/20 dark:border-blue-400/20 rounded-2xl px-5 py-3 text-lg font-bold text-gray-800 dark:text-white placeholder:text-gray-400 dark:placeholder:text-gray-600 focus:outline-none focus:border-blue-500/50 transition-all text-center">
                </div>

                <!-- Input Area -->
                <div class="flex gap-2 mb-4">
                    <input type="text" id="task-input" placeholder="Nueva tarea / Materia..." 
                           class="flex-1 bg-white/50 dark:bg-black/20 border border-white/50 dark:border-white/10 rounded-xl px-4 py-2 focus:outline-none focus:border-blue-500 dark:text-white transition-colors"
                           onkeypress="if(event.key === 'Enter') addTask()">
                    <button onclick="addTask()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl transition-colors">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>

                <!-- List Area -->
                <div class="flex-1 overflow-y-auto pr-1">
                    <div id="task-list" class="space-y-3 pb-4">
                        <!-- Las tareas se inyectan aquí -->
                    </div>
                    
                    <div id="empty-tasks" class="text-center py-10 text-gray-400 dark:text-gray-500">
                        <i class="fa-regular fa-clipboard text-4xl mb-3 opacity-50"></i>
                        <p class="text-sm">Agrega tareas para organizar tu tiempo de vuelo.</p>
                    </div>
                </div>

                <!-- Summary Footer -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-2">
                    <div class="flex justify-between items-center mb-4 text-sm">
                        <span class="text-gray-500 dark:text-gray-400">Total asignado:</span>
                        <span id="total-percent" class="font-bold text-gray-800 dark:text-white">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-4 overflow-hidden">
                        <div id="total-percent-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    
                    <button onclick="confirmAndSaveItinerary()" id="btn-generate-ticket" disabled 
                            class="w-full bg-gray-900 dark:bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-black dark:hover:bg-blue-700 transition transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed">
                        Confirmar y Generar Boucher
                    </button>
                    
                    <button onclick="showBoardingPass()" class="w-full mt-3 text-xs font-bold text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        Continuar sin guardar
                    </button>
                </div>
            </div>
        </div>

        <!-- PANTALLA 2: BOUCHER / BOARDING PASS -->
        <div id="screen-ticket" class="hidden-screen flex items-center justify-center bg-black/40 backdrop-blur-md p-4 h-full">
            <div class="w-full max-w-lg glass-panel !bg-white/90 dark:!bg-gray-800/90 rounded-3xl shadow-2xl overflow-hidden flex flex-col">
                <!-- Header -->
                <div class="pass-header flex justify-between items-center p-6 !bg-blue-600 dark:!bg-blue-500 text-white">
                    <div class="flex flex-col">
                        <span class="font-bold tracking-widest uppercase text-[10px] opacity-70">Flyper Pass</span>
                        <span class="font-black text-lg tracking-tight" id="ticket-session-name">Misión de Estudio</span>
                    </div>
                    <i class="fa-solid fa-earth-americas text-2xl opacity-50"></i>
                </div>
                
                <!-- Body -->
                <div class="p-8">
                    <div class="flex justify-between items-center mb-8">
                        <div class="text-center">
                            <div class="text-4xl font-black text-gray-800 dark:text-white" id="ticket-origin">MAD</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 uppercase mt-1">Salida</div>
                        </div>
                        
                        <div class="flex-1 px-4 flex flex-col items-center">
                            <i class="fa-solid fa-plane text-xl text-blue-500"></i>
                            <div class="w-full h-px bg-gray-300 dark:bg-gray-600 my-2 relative">
                                <div class="absolute w-2 h-2 rounded-full left-0 top-1/2 -translate-y-1/2 bg-blue-500"></div>
                                <div class="absolute w-2 h-2 rounded-full right-0 top-1/2 -translate-y-1/2 bg-blue-500"></div>
                            </div>
                            <div class="text-xs font-bold text-blue-500" id="ticket-duration">2h 15m</div>
                        </div>

                        <div class="text-center">
                            <div class="text-4xl font-black text-gray-800 dark:text-white" id="ticket-dest">LDN</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 uppercase mt-1">Llegada</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white/50 dark:bg-black/20 border border-gray-100 dark:border-white/5 p-4 rounded-2xl">
                            <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">Clase</div>
                            <div class="font-bold text-gray-700 dark:text-gray-200">Business / Focus</div>
                        </div>
                        <div class="bg-white/50 dark:bg-black/20 border border-gray-100 dark:border-white/5 p-4 rounded-2xl">
                            <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">Arribo Estimado</div>
                            <div class="flex flex-col">
                                <span class="font-bold text-gray-700 dark:text-gray-200" id="ticket-arrival">--:--</span>
                                <span class="text-[10px] text-gray-500" id="ticket-arrival-date">--/--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer / Actions -->
                <div class="p-6 bg-gray-50/50 dark:bg-black/20 border-t border-dashed border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <button onclick="showScreen('screen-todo')" class="text-gray-400 font-bold hover:text-gray-600 dark:hover:text-gray-200 text-sm">Editar</button>
                    <button onclick="startFlight()" class="text-white px-8 py-3 rounded-full font-black shadow-lg hover:scale-105 transition-transform flex items-center bg-blue-600 dark:bg-blue-500">
                        Despegar <i class="fa-solid fa-plane-departure ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL ERROR / ADVERTENCIA -->
        <div id="error-modal" class="hidden fixed inset-0 z-[250] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-opacity">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center border border-gray-200 dark:border-gray-700">
                <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 dark:text-red-400">
                    <i class="fa-solid fa-circle-exclamation text-2xl"></i>
                </div>
                <h2 id="error-modal-title" class="text-xl font-bold text-gray-800 dark:text-white mb-2">¡Límite Excedido!</h2>
                <p id="error-modal-msg" class="text-sm text-gray-500 dark:text-gray-400 mb-6">El tiempo total asignado no puede superar el 100%.</p>
                
                <button onclick="closeErrorModal()" class="w-full bg-gray-900 dark:bg-blue-600 text-white font-bold py-3 rounded-xl hover:opacity-90 transition">
                    Entendido
                </button>
            </div>
        </div>

        <!-- TOAST NOTIFICATION -->
        <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-[1000] hidden transition-opacity duration-300 pointer-events-none">
            <div class="glass-panel px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 border border-gray-200 dark:border-gray-700">
                <i id="toast-icon" class="fa-solid fa-check-circle text-green-500"></i>
                <span id="toast-msg" class="font-bold text-gray-800 dark:text-white text-sm">Notificación</span>
            </div>
        </div>

        <!-- MODAL IMPORTAR VUELO -->
        <div id="import-modal" class="hidden fixed inset-0 z-[300] flex items-center justify-center bg-black/60 backdrop-blur-md p-4 transition-opacity">
            <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-md w-full p-6 border border-gray-200 dark:border-gray-700">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 dark:text-blue-400">
                        <i class="fa-solid fa-file-import text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-black text-gray-800 dark:text-white mb-1">Importar Plan de Vuelo</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Se ha detectado un itinerario compartido</p>
                </div>

                <div class="bg-gray-50 dark:bg-gray-900/50 p-4 rounded-2xl mb-6 border border-gray-100 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-3">
                        <div class="font-bold text-gray-800 dark:text-white text-lg" id="import-name">Nombre del Plan</div>
                        <div class="text-xs font-mono bg-blue-100 dark:bg-blue-900/40 text-blue-600 dark:text-blue-300 px-2 py-1 rounded-lg" id="import-duration">-- min</div>
                    </div>
                    <div class="flex items-center justify-between text-sm text-gray-500 dark:text-gray-400">
                        <div class="flex items-center gap-2">
                            <span id="import-origin" class="font-black text-gray-800 dark:text-gray-200">XXX</span>
                            <i class="fa-solid fa-arrow-right text-xs"></i>
                            <span id="import-dest" class="font-black text-gray-800 dark:text-gray-200">YYY</span>
                        </div>
                        <div id="import-task-count">0 tareas</div>
                    </div>
                </div>
                
                <div class="flex flex-col gap-3">
                    <button onclick="importFlyNow()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition transform hover:scale-[1.02]">
                        <i class="fa-solid fa-plane-departure mr-2"></i> Volar Ahora
                    </button>
                    <div class="flex gap-3">
                        <button onclick="importSave()" class="flex-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white font-bold py-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                            <i class="fa-solid fa-save mr-1"></i> Guardar
                        </button>
                        <button onclick="closeImportModal()" class="flex-1 bg-transparent border border-gray-200 dark:border-gray-700 text-gray-500 hover:text-red-500 font-bold py-3 rounded-xl transition">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL ESTADÍSTICAS -->
        <div id="stats-modal" class="hidden fixed inset-0 z-[250] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-opacity">
            <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-sm w-full max-h-[85vh] flex flex-col border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-900/50">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400">
                            <i class="fa-solid fa-chart-pie"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-black text-gray-800 dark:text-white">Estadísticas</h2>
                            <p class="text-xs text-gray-500">Tu historial de piloto</p>
                        </div>
                    </div>
                    <button onclick="closeStats()" class="text-gray-400 hover:text-red-500 text-xl"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-6 bg-white dark:bg-gray-800" id="stats-content">
                    <!-- Stats Injected via JS -->
                </div>
            </div>
        </div>

        <!-- MODAL LOGROS (ACHIEVEMENTS) -->
        <div id="achievements-modal" class="hidden fixed inset-0 z-[250] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-opacity">
            <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-4xl w-full max-h-[85vh] flex flex-col border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-900/50">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-100 dark:bg-yellow-900/30 flex items-center justify-center text-yellow-600 dark:text-yellow-400">
                            <i class="fa-solid fa-trophy"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-black text-gray-800 dark:text-white">Trofeos y Logros</h2>
                            <p class="text-xs text-gray-500" id="achievements-summary">Cargando...</p>
                        </div>
                    </div>
                    <button onclick="closeAchievements()" class="text-gray-400 hover:text-red-500 text-xl"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-6 bg-white dark:bg-gray-800">
                    <div id="achievements-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Los logros se inyectan aquí -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL HANGAR (ITINERARIOS GUARDADOS) -->
        <div id="hangar-modal" class="hidden fixed inset-0 z-[250] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-opacity">
            <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-md w-full max-h-[80vh] flex flex-col border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-black text-gray-800 dark:text-white">Mi Hangar</h2>
                        <p class="text-xs text-gray-500">Tus itinerarios guardados localmente</p>
                    </div>
                    <button onclick="closeHangar()" class="text-gray-400 hover:text-red-500 text-xl"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div id="hangar-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50/50 dark:bg-gray-900/20">
                    <!-- Los itinerarios se inyectan aquí -->
                </div>

                <div class="p-4 bg-white dark:bg-gray-800 border-t border-gray-100 dark:border-gray-700 text-center">
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest font-bold">Flyper hangar</p>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="src/airports.js"></script>
    <script src="src/achievements.js"></script>
    <script>
        // --- UTILS ---
        function escapeHTML(str) {
            if (!str) return "";
            return str.replace(/[&<>'"]/g, 
                tag => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    "'": '&#39;',
                    '"': '&quot;'
                }[tag])
            );
        }

        // --- THEME ---
        let isDarkMode = false;
        
        // --- DATA ---
        let trip = {
            origin: null,
            dest: null,
            distance: 0,
            durationMs: 0,
            startTime: 0,
            sessionName: '',
            tasks: []
        };

        function toggleTheme() {
            const html = document.documentElement;
            isDarkMode = !isDarkMode;
            html.classList.toggle('dark', isDarkMode);
            localStorage.theme = isDarkMode ? 'dark' : 'light';
        }

        // --- TASK LOGIC ---
        function showTasksScreen() {
            renderTasks();
            showScreen('screen-todo');
        }

        function addTask() {
            const input = document.getElementById('task-input');
            const title = input.value.trim();
            if (!title) return;

            const currentTotal = trip.tasks.reduce((sum, t) => sum + t.percent, 0);
            const remaining = Math.max(0, 100 - currentTotal);
            const newPercent = remaining > 0 ? (remaining > 20 ? 20 : remaining) : 0;

            const newTask = {
                id: Date.now().toString(),
                title: title,
                percent: newPercent,
                completed: false
            };
            trip.tasks.push(newTask);
            input.value = '';
            renderTasks();
        }

        function removeTask(id) {
            trip.tasks = trip.tasks.filter(t => t.id !== id);
            renderTasks();
        }

        function showError(title, msg) {
            document.getElementById('error-modal-title').innerText = title;
            document.getElementById('error-modal-msg').innerText = msg;
            document.getElementById('error-modal').classList.remove('hidden');
        }

        function closeErrorModal() {
            document.getElementById('error-modal').classList.add('hidden');
        }

        function updateTaskPercent(id, newPercent) {
            const task = trip.tasks.find(t => t.id === id);
            if (task) {
                const val = parseInt(newPercent) || 0;
                
                const otherTasksTotal = trip.tasks.filter(t => t.id !== id).reduce((sum, t) => sum + t.percent, 0);
                
                if (otherTasksTotal + val > 100) {
                    showError("Límite de Tiempo", "El tiempo total de las tareas no puede superar el 100% del vuelo. Ajusta otras tareas primero.");
                    renderTasks();
                    return;
                }

                task.percent = val;
                renderTasks();
            }
        }

        function renderTasks() {
            const list = document.getElementById('task-list');
            const empty = document.getElementById('empty-tasks');
            
            list.innerHTML = '';
            
            if (trip.tasks.length === 0) {
                empty.style.display = 'block';
                document.getElementById('btn-generate-ticket').disabled = true;
            } else {
                empty.style.display = 'none';
                document.getElementById('btn-generate-ticket').disabled = false;
            }

            const totalMinutes = Math.round(trip.durationMs / 60000);
            document.getElementById('todo-total-time').innerText = `Vuelo: ${totalMinutes} min`;

            let totalPercent = 0;

            trip.tasks.forEach(task => {
                totalPercent += task.percent;
                const taskMin = Math.round((task.percent / 100) * totalMinutes);

                const el = document.createElement('div');
                el.className = 'task-card bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 p-3 rounded-xl shadow-sm flex items-center gap-3 select-none';
                el.dataset.id = task.id;
                
                el.innerHTML = `
                    <div class="cursor-grab text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 p-1 handle">
                        <i class="fa-solid fa-grip-vertical"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold text-gray-800 dark:text-white text-sm">${escapeHTML(task.title)}</div>
                        <div class="text-xs text-blue-600 dark:text-blue-400 font-mono">${taskMin} min</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" min="0" max="100" value="${task.percent}" 
                            class="w-16 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-500 rounded px-2 py-1 text-xs text-center focus:outline-none focus:border-blue-500 dark:text-white"
                            onchange="updateTaskPercent('${task.id}', this.value)">
                        <span class="text-xs text-gray-500">%</span>
                        <button onclick="removeTask('${task.id}')" class="text-red-400 hover:text-red-600 ml-2">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
                list.appendChild(el);
            });

            document.getElementById('total-percent').innerText = totalPercent + '%';
            document.getElementById('total-percent-bar').style.width = Math.min(100, totalPercent) + '%';
            
            if (totalPercent > 100) {
                document.getElementById('total-percent').classList.add('text-red-500');
                document.getElementById('total-percent-bar').classList.add('bg-red-500');
                document.getElementById('total-percent-bar').classList.remove('bg-blue-500');
            } else {
                document.getElementById('total-percent').classList.remove('text-red-500');
                document.getElementById('total-percent-bar').classList.remove('bg-red-500');
                document.getElementById('total-percent-bar').classList.add('bg-blue-500');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const list = document.getElementById('task-list');
            new Sortable(list, {
                handle: '.handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    const newOrder = [];
                    list.querySelectorAll('.task-card').forEach(card => {
                        const id = card.dataset.id;
                        const task = trip.tasks.find(t => t.id === id);
                        if(task) newOrder.push(task);
                    });
                    trip.tasks = newOrder;
                }
            });
            
            // Check theme
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                isDarkMode = true;
            } else {
                document.documentElement.classList.remove('dark');
                isDarkMode = false;
            }
        });

        // --- ACHIEVEMENTS & STATS LOGIC ---
        function getStats() {
            const defaultStats = {
                totalFlightTime: 0,
                totalFlights: 0,
                abortedFlights: 0,
                airportsVisited: [],
                currentStreak: 0,
                longestStreak: 0,
                lastFlightDate: null,
                perfectFlights: 0,
                flightsWithoutPause: 0,
                longestSingleFlight: 0,
                flightsByHour: {},
                sharedPlans: 0,
                savedItineraries: 0
            };
            return { ...defaultStats, ...JSON.parse(localStorage.getItem('flyper_stats') || "{}") };
        }

        function saveStats(stats) {
            localStorage.setItem('flyper_stats', JSON.stringify(stats));
        }

        function getUnlockedAchievements() {
            return JSON.parse(localStorage.getItem('flyper_achievements')) || {};
        }
        
        function saveUnlockedAchievements(unlocked) {
            localStorage.setItem('flyper_achievements', JSON.stringify(unlocked));
        }

        function updateStatsForAction(type) {
            const stats = getStats();
            if (type === 'save') stats.savedItineraries++;
            if (type === 'share') stats.sharedPlans++;
            saveStats(stats);
            checkAchievements(stats);
        }

        function checkAchievements(stats) {
            const unlocked = getUnlockedAchievements();
            const newUnlocks = [];

            for (const key in ACHIEVEMENTS) {
                if (unlocked[key]) continue;

                const achievement = ACHIEVEMENTS[key];
                if (achievement.condition(stats)) {
                    unlocked[key] = new Date().toISOString();
                    newUnlocks.push(achievement);
                    showAchievementUnlocked(achievement);
                }
            }

            if (newUnlocks.length > 0) {
                saveUnlockedAchievements(unlocked);
            }
        }

        function showAchievementUnlocked(achievement) {
            const sfx = document.getElementById('sfx-achievement');
            if (sfx) {
                sfx.currentTime = 0;
                sfx.play().catch(e => {});
            }

            showToast(`¡Logro Desbloqueado: ${achievement.name}!`, "success");
            
            if (!document.getElementById('achievements-modal').classList.contains('hidden')) {
                renderAchievements();
            }
        }

        function openAchievements() {
            renderAchievements();
            document.getElementById('achievements-modal').classList.remove('hidden');
        }

        function closeAchievements() {
            document.getElementById('achievements-modal').classList.add('hidden');
        }

        function renderAchievements() {
            const grid = document.getElementById('achievements-grid');
            const unlocked = getUnlockedAchievements();
            const stats = getStats();
            grid.innerHTML = '';

            const unlockedCount = Object.keys(unlocked).length;
            const totalCount = Object.keys(ACHIEVEMENTS).length;
            
            document.getElementById('achievements-summary').innerText = 
                `${unlockedCount}/${totalCount} desbloqueados • ${Math.floor(stats.totalFlightTime / 60)}h ${stats.totalFlightTime % 60}m vuelo total`;

            // Nota sobre el tiempo
            const note = document.createElement('div');
            note.className = "col-span-full bg-blue-50 dark:bg-blue-900/20 p-3 rounded-xl border border-blue-100 dark:border-blue-800 mb-2 flex items-start gap-2";
            note.innerHTML = `
                <i class="fa-solid fa-circle-info text-blue-500 mt-0.5"></i>
                <p class="text-xs text-blue-800 dark:text-blue-200">
                    <strong>Importante:</strong> Las horas de vuelo y estadísticas solo se registran al 
                    <span class="underline decoration-blue-500">aterrizar y completar el vuelo</span>.
                </p>
            `;
            grid.appendChild(note);

            for (const key in ACHIEVEMENTS) {
                const ach = ACHIEVEMENTS[key];
                const isUnlocked = !!unlocked[key];
                const dateStr = isUnlocked ? new Date(unlocked[key]).toLocaleDateString() : '';
                
                const currentVal = ach.getValue ? ach.getValue(stats) : 0;
                const targetVal = ach.target || 1;
                const percent = Math.min(100, Math.max(0, (currentVal / targetVal) * 100));

                const el = document.createElement('div');
                el.className = `p-4 rounded-2xl border flex flex-col gap-2 transition-all relative overflow-hidden ${
                    isUnlocked 
                    ? 'bg-white dark:bg-gray-700 border-yellow-200 dark:border-yellow-900/50 shadow-sm' 
                    : 'bg-gray-50 dark:bg-gray-800 border-gray-100 dark:border-gray-700 opacity-90'
                }`;

                el.innerHTML = `
                    <div class="flex items-start gap-4 z-10">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl shrink-0 ${
                            isUnlocked ? 'bg-yellow-100 text-yellow-600' : 'bg-gray-200 text-gray-400 grayscale'
                        }">
                            ${ach.icon}
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-gray-800 dark:text-white text-sm flex justify-between">
                                <span>${ach.name}</span>
                                ${!isUnlocked ? `<span class="text-xs text-gray-400">${currentVal}/${targetVal}</span>` : ''}
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 leading-tight mb-1">${ach.description}</div>
                            
                            ${isUnlocked 
                                ? `<div class="text-[10px] text-blue-500 font-bold mt-1"><i class="fa-solid fa-check"></i> Conseguido: ${dateStr}</div>` 
                                : `
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 h-1.5 rounded-full mt-2 overflow-hidden">
                                        <div class="bg-blue-400 h-full rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                                    </div>
                                    <div class="text-[9px] text-gray-400 text-right mt-0.5">${percent.toFixed(0)}%</div>
                                `
                            }
                        </div>
                    </div>
                `;
                grid.appendChild(el);
            }
        }

        // --- STATS MODAL LOGIC ---
        function openStats() {
            renderStats();
            document.getElementById('stats-modal').classList.remove('hidden');
        }

        function closeStats() {
            document.getElementById('stats-modal').classList.add('hidden');
        }

        function renderStats() {
            const stats = getStats();
            const container = document.getElementById('stats-content');
            
            const totalHours = Math.floor(stats.totalFlightTime / 60);
            const totalMins = stats.totalFlightTime % 60;
            const successRate = stats.totalFlights > 0 
                ? Math.round((stats.totalFlights / (stats.totalFlights + (stats.abortedFlights || 0))) * 100) 
                : 0;

            container.innerHTML = `
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-2xl border border-blue-100 dark:border-blue-800/50 flex flex-col items-center justify-center text-center">
                        <div class="text-3xl font-black text-blue-600 dark:text-blue-400 mb-1">${totalHours}h ${totalMins}m</div>
                        <div class="text-xs text-blue-400 uppercase font-bold tracking-wider">Tiempo de Vuelo</div>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-2xl border border-orange-100 dark:border-orange-800/50 flex flex-col items-center justify-center text-center">
                        <div class="text-3xl font-black text-orange-500 dark:text-orange-400 mb-1 flex items-center gap-2">
                            ${stats.currentStreak} <i class="fa-solid fa-fire text-xl"></i>
                        </div>
                        <div class="text-xs text-orange-400 uppercase font-bold tracking-wider">Racha Actual</div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 mb-6">
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-xl text-center">
                        <i class="fa-solid fa-plane-arrival text-green-500 text-xl mb-2"></i>
                        <div class="font-bold text-gray-800 dark:text-white text-lg">${stats.totalFlights}</div>
                        <div class="text-[10px] text-gray-400 uppercase">Completados</div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-xl text-center">
                        <i class="fa-solid fa-plane-slash text-red-400 text-xl mb-2"></i>
                        <div class="font-bold text-gray-800 dark:text-white text-lg">${stats.abortedFlights || 0}</div>
                        <div class="text-[10px] text-gray-400 uppercase">Abortados</div>
                    </div>
                     <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-xl text-center">
                        <i class="fa-solid fa-map-location-dot text-indigo-400 text-xl mb-2"></i>
                        <div class="font-bold text-gray-800 dark:text-white text-lg">${stats.airportsVisited.length}</div>
                        <div class="text-[10px] text-gray-400 uppercase">Aeropuertos</div>
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-xl">
                        <span class="text-sm text-gray-500 dark:text-gray-400">Tasa de Éxito</span>
                        <span class="font-bold text-gray-800 dark:text-white">${successRate}%</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-xl">
                        <span class="text-sm text-gray-500 dark:text-gray-400">Mejor Racha Histórica</span>
                        <span class="font-bold text-gray-800 dark:text-white">${stats.longestStreak} días</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-xl">
                        <span class="text-sm text-gray-500 dark:text-gray-400">Vuelo más largo</span>
                        <span class="font-bold text-gray-800 dark:text-white">${stats.longestSingleFlight} min</span>
                    </div>
                </div>
            `;
        }

        // --- INIT & CORE LOGIC ---
        window.onload = () => { 
            loadSelects(); 
            checkUrlForPlan();
            // Si hay vuelo activo, sugerir ir al vuelo? No, solo si el usuario va a app.html
        };

        let tomSelectOrigin, tomSelectDest;

        function loadSelects() {
            const s1 = document.getElementById('origin');
            const s2 = document.getElementById('destination');
            
            const sorted = [...airports].sort((a,b) => {
                if (a.country < b.country) return -1;
                if (a.country > b.country) return 1;
                return a.city.localeCompare(b.city);
            });

            const groups = {};
            sorted.forEach(ap => {
                if (!groups[ap.country]) groups[ap.country] = [];
                groups[ap.country].push(ap);
            });

            const buildOptions = () => {
                let html = '<option value="" disabled selected>Buscar aeropuerto...</option>';
                for (const [country, list] of Object.entries(groups)) {
                    html += `<optgroup label="${country}">`;
                    list.forEach(ap => {
                        html += `<option value="${ap.code}">${ap.city} (${ap.code}) - ${ap.country}</option>`;
                    });
                    html += `</optgroup>`;
                }
                return html;
            };

            const optionsHTML = buildOptions();
            s1.innerHTML = optionsHTML;
            s2.innerHTML = optionsHTML;

            const tsConfig = {
                create: false,
                sortField: { field: "text", direction: "asc" },
                placeholder: "Escribe para buscar...",
                render: {
                    option: function(data, escape) {
                        const parts = data.text.split(' - ');
                        return '<div>' +
                                '<span class="font-bold block">' + escape(parts[0]) + '</span>' +
                                '<span class="text-xs text-gray-500 block">' + escape(parts[1] || '') + '</span>' +
                            '</div>';
                    },
                    item: function(data, escape) {
                        return '<div>' + escape(data.text) + '</div>';
                    }
                },
                onChange: function() {
                    updatePreview();
                }
            };

            tomSelectOrigin = new TomSelect('#origin', tsConfig);
            tomSelectDest = new TomSelect('#destination', tsConfig);
        }

        function getAirport(code) { return airports.find(a => a.code === code); }

        function calculateDist(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function formatTime(mins) {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return h > 0 ? `${h}h ${m}m` : `${m} min`;
        }

        function updatePreview() {
            const oVal = document.getElementById('origin').value;
            const dVal = document.getElementById('destination').value;
            const btn = document.getElementById('btn-goto-tasks');
            const box = document.getElementById('preview-box');

            if (oVal && dVal && oVal !== dVal) {
                const origin = getAirport(oVal);
                const dest = getAirport(dVal);
                const dist = calculateDist(origin.lat, origin.lon, dest.lat, dest.lon);
                const timeHrs = dist / 850; 
                const totalMins = Math.round(timeHrs * 60) + 15;

                trip.origin = origin;
                trip.dest = dest;
                trip.distance = dist;
                trip.durationMs = totalMins * 60 * 1000;

                document.getElementById('preview-time').innerText = formatTime(totalMins);
                document.getElementById('preview-dist').innerText = Math.round(dist) + " km";
                box.classList.remove('hidden');
                btn.disabled = false;
            } else {
                box.classList.add('hidden');
                btn.disabled = true;
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.active-screen').forEach(el => {
                el.classList.remove('active-screen');
                el.classList.add('hidden-screen');
            });
            const target = document.getElementById(id);
            target.classList.remove('hidden-screen');
            target.classList.add('active-screen');
        }

        function showBoardingPass() {
            const sessionInput = document.getElementById('session-name-input');
            trip.sessionName = sessionInput.value.trim() || "Misión de Estudio";
            document.getElementById('ticket-session-name').innerText = trip.sessionName;

            document.getElementById('ticket-origin').innerText = escapeHTML(trip.origin.code);
            document.getElementById('ticket-dest').innerText = escapeHTML(trip.dest.code);
            document.getElementById('ticket-duration').innerText = document.getElementById('preview-time').innerText;
            
            const etaDate = new Date(Date.now() + trip.durationMs);
            const etaTime = etaDate.getHours().toString().padStart(2, '0') + ":" + etaDate.getMinutes().toString().padStart(2, '0');
            const etaDateStr = etaDate.getDate().toString().padStart(2, '0') + "/" + (etaDate.getMonth() + 1).toString().padStart(2, '0');
            
            const ticketArrival = document.getElementById('ticket-arrival');
            if (ticketArrival) ticketArrival.innerText = etaTime;
            const ticketArrivalDate = document.getElementById('ticket-arrival-date');
            if (ticketArrivalDate) ticketArrivalDate.innerText = etaDateStr;

            showScreen('screen-ticket');
        }

        function startFlight() {
            // Set basic Start Time
            trip.startTime = Date.now();
            
            // Save state for app.html to pick up
            const state = {
                trip: trip,
                elapsed: 0,
                timestamp: Date.now()
            };
            localStorage.setItem('flyper_active_flight', JSON.stringify(state));

            // Redirect to App
            window.location.href = 'app.html';
        }

        // --- HANGAR & LOCAL STORAGE LOGIC ---
        function confirmAndSaveItinerary() {
            saveCurrentItinerary();
            showBoardingPass();
        }

        function saveCurrentItinerary() {
            const sessionInput = document.getElementById('session-name-input');
            const sessionName = sessionInput.value.trim() || "Misión de Estudio";
            
            if (!trip.origin || !trip.dest) {
                showError("Plan incompleto", "Debes seleccionar origen y destino antes de guardar.");
                return;
            }

            const itinerary = {
                id: Date.now(),
                name: sessionName,
                origin: trip.origin,
                dest: trip.dest,
                tasks: trip.tasks,
                durationMs: trip.durationMs,
                distance: trip.distance,
                date: new Date().toLocaleDateString()
            };

            let history = JSON.parse(localStorage.getItem('flyper_hangar') || "[]");
            history.unshift(itinerary); 
            localStorage.setItem('flyper_hangar', JSON.stringify(history));
            updateStatsForAction('save');

            const btn = event.currentTarget;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> ¡Guardado!';
            btn.classList.replace('text-blue-600', 'text-green-600');
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.replace('text-green-600', 'text-blue-600');
            }, 2000);
        }

        function openHangar() {
            renderHangarList();
            document.getElementById('hangar-modal').classList.remove('hidden');
        }

        function closeHangar() {
            document.getElementById('hangar-modal').classList.add('hidden');
        }

        function renderHangarList() {
            const list = document.getElementById('hangar-list');
            const history = JSON.parse(localStorage.getItem('flyper_hangar') || "[]");
            
            list.innerHTML = '';

            if (history.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-10 opacity-40">
                        <i class="fa-solid fa-plane-slash text-4xl mb-3"></i>
                        <p class="text-sm">El hangar está vacío.</p>
                    </div>
                `;
                return;
            }

            history.forEach(item => {
                const el = document.createElement('div');
                el.className = "bg-white dark:bg-gray-700 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-600 flex justify-between items-center gap-4 hover:border-blue-400 transition-colors cursor-pointer group";
                el.onclick = (e) => {
                    if (e.target.closest('.btn-action')) return;
                    loadItinerary(item.id);
                };

                el.innerHTML = `
                    <div class="flex-1">
                        <div class="text-xs text-blue-500 font-bold uppercase tracking-tighter mb-1">${item.date}</div>
                        <div class="font-bold text-gray-800 dark:text-white leading-tight mb-1">${escapeHTML(item.name)}</div>
                        <div class="text-[10px] text-gray-500 flex items-center gap-1">
                            ${escapeHTML(item.origin.code)} <i class="fa-solid fa-arrow-right text-[8px]"></i> ${escapeHTML(item.dest.code)} 
                            • ${item.tasks.length} tareas
                        </div>
                    </div>
                    <div class="flex items-center gap-1">
                        <button class="btn-action text-gray-300 hover:text-blue-500 p-2 transition-colors" title="Compartir" onclick="shareItinerary(${item.id})">
                            <i class="fa-solid fa-share-nodes"></i>
                        </button>
                        <button class="btn-action text-gray-300 hover:text-red-500 p-2 transition-colors" title="Eliminar" onclick="deleteItinerary(${item.id})">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                        <i class="fa-solid fa-chevron-right text-gray-300 group-hover:text-blue-500 transition-colors ml-1"></i>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        // --- SHARING LOGIC ---
        function shareItinerary(id) {
            const history = JSON.parse(localStorage.getItem('flyper_hangar') || "[]");
            const item = history.find(i => i.id === id);
            if (!item) return;

            const shareable = {
                n: item.name,
                o: item.origin.code, 
                d: item.dest.code,
                t: item.durationMs,
                tasks: item.tasks.map(t => ({
                    n: t.title,
                    p: t.percent
                }))
            };

            try {
                const json = JSON.stringify(shareable);
                const encoded = btoa(unescape(encodeURIComponent(json)));
                const url = window.location.origin + window.location.pathname + "?plan=" + encoded;

                navigator.clipboard.writeText(url).then(() => {
                    updateStatsForAction('share');
                    showToast("¡Link copiado al portapapeles!", "success");
                }).catch(err => {
                    console.error('Error copying link: ', err);
                    showToast("Error al copiar link", "error");
                });
            } catch (e) {
                console.error("Encoding error:", e);
                showToast("Error al generar el link", "error");
            }
        }

        function showToast(msg, type = "success") {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            const iconEl = document.getElementById('toast-icon');

            msgEl.innerText = msg;
            if (type === "success") {
                iconEl.className = "fa-solid fa-check-circle text-green-500";
            } else {
                iconEl.className = "fa-solid fa-circle-exclamation text-red-500";
            }

            toast.classList.remove('hidden');
            toast.classList.remove('opacity-0');
            
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => {
                    toast.classList.add('hidden');
                    toast.classList.remove('opacity-0'); 
                }, 300);
            }, 3000);
        }

        // --- IMPORT LOGIC ---
        let pendingImport = null;

        function checkUrlForPlan() {
            const params = new URLSearchParams(window.location.search);
            const encoded = params.get('plan');

            if (encoded) {
                try {
                    const json = decodeURIComponent(escape(atob(encoded)));
                    const data = JSON.parse(json);
                    validateAndPrepareImport(data);
                    
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                } catch (e) {
                    console.error("Decoding error:", e);
                    showToast("Link de vuelo inválido", "error");
                }
            }
        }

        function validateAndPrepareImport(data) {
            if (!data.n || !data.o || !data.d || !data.tasks) {
                showToast("Datos del plan corruptos", "error");
                return;
            }

            const originAp = getAirport(data.o);
            const destAp = getAirport(data.d);

            if (!originAp || !destAp) {
                showToast("Aeropuerto desconocido en el plan", "error");
                return;
            }

            pendingImport = {
                name: data.n,
                origin: originAp,
                dest: destAp,
                durationMs: data.t || 0,
                tasks: data.tasks.map((t, idx) => ({
                    id: Date.now().toString() + idx,
                    title: t.n,
                    percent: t.p,
                    completed: false
                }))
            };

            const dist = calculateDist(originAp.lat, originAp.lon, destAp.lat, destAp.lon);
            pendingImport.distance = dist;
            if (!pendingImport.durationMs) {
                const timeHrs = dist / 850; 
                pendingImport.durationMs = (Math.round(timeHrs * 60) + 15) * 60 * 1000;
            }

            document.getElementById('import-name').innerText = pendingImport.name;
            document.getElementById('import-duration').innerText = formatTime(Math.round(pendingImport.durationMs / 60000));
            document.getElementById('import-origin').innerText = pendingImport.origin.code;
            document.getElementById('import-dest').innerText = pendingImport.dest.code;
            document.getElementById('import-task-count').innerText = pendingImport.tasks.length + " tareas";

            document.getElementById('import-modal').classList.remove('hidden');
        }

        function closeImportModal() {
            document.getElementById('import-modal').classList.add('hidden');
            pendingImport = null;
        }

        function importFlyNow() {
            if (!pendingImport) return;
            
            trip = {
                ...pendingImport,
                startTime: 0,
                sessionName: pendingImport.name
            };
            
            if(tomSelectOrigin) tomSelectOrigin.setValue(trip.origin.code, true);
            if(tomSelectDest) tomSelectDest.setValue(trip.dest.code, true);
            document.getElementById('session-name-input').value = trip.sessionName || trip.name;
            
            updatePreview(); 
            showTasksScreen();
            
            closeImportModal();
            showToast("Plan importado correctamente");
        }

        function importSave() {
            if (!pendingImport) return;

            const itinerary = {
                id: Date.now(),
                name: pendingImport.name,
                origin: pendingImport.origin,
                dest: pendingImport.dest,
                tasks: pendingImport.tasks,
                durationMs: pendingImport.durationMs,
                distance: pendingImport.distance,
                date: new Date().toLocaleDateString()
            };

            let history = JSON.parse(localStorage.getItem('flyper_hangar') || "[]");
            history.unshift(itinerary);
            localStorage.setItem('flyper_hangar', JSON.stringify(history));
            
            closeImportModal();
            showToast("Plan guardado en el Hangar");
            openHangar(); 
        }

        function deleteItinerary(id) {
            let history = JSON.parse(localStorage.getItem('flyper_hangar') || "[]");
            history = history.filter(item => item.id !== id);
            localStorage.setItem('flyper_hangar', JSON.stringify(history));
            renderHangarList();
        }

        function loadItinerary(id) {
            const history = JSON.parse(localStorage.getItem('flyper_hangar') || "[]");
            const item = history.find(i => i.id === id);
            
            if (!item) return;

            trip.origin = item.origin;
            trip.dest = item.dest;
            trip.tasks = [...item.tasks];
            trip.durationMs = item.durationMs;
            trip.distance = item.distance;
            trip.sessionName = item.name;

            if (tomSelectOrigin) tomSelectOrigin.setValue(item.origin.code, true);
            if (tomSelectDest) tomSelectDest.setValue(item.dest.code, true);
            
            document.getElementById('session-name-input').value = item.name;

            closeHangar();
            updatePreview();
            showTasksScreen();
        }
    </script>
</body>
</html>